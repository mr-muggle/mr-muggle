(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{739:function(a,t,s){"use strict";s.r(t);var n=s(74),r=Object(n.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h2",{attrs:{id:"引言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#引言"}},[a._v("#")]),a._v(" 引言")]),a._v(" "),t("p",[a._v("在项目迭代开发中，难免会有更新数据库 Schema 的情况，比如添加新表、在表中增加字段或者删除字段等，那么当我对数据库进行一系列操作后，如何快速地在其他同事的电脑上同步？如何在测试/生产服务器上快速同步？\n每次发版的时候，由于大家都可能有 sql 更改情况，这样就会有以下痛点：")]),a._v(" "),t("ul",[t("li",[a._v("忘记某些 sql 修改")]),a._v(" "),t("li",[a._v("每个开发人员的 sql 的执行顺序问题")]),a._v(" "),t("li",[a._v("重复更新")]),a._v(" "),t("li",[a._v("需要手动去数据库执行脚本")])]),a._v(" "),t("p",[a._v("以上问题以及痛点可以通过 Flyway 工具来解决，Flyway 可以实现自动化的数据库版本管理，并且能够记录数据库版本更新记录。")]),a._v(" "),t("h2",{attrs:{id:"flyway支持的数据库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#flyway支持的数据库"}},[a._v("#")]),a._v(" Flyway支持的数据库")]),a._v(" "),t("p",[a._v("Flyway 是独立于数据库的应用、管理并跟踪数据库变更的数据库版本管理工具。用通俗的话讲，Flyway 可以像 Git 管理不同人的代码那样，管理不同人的 sql 脚本，从而做到数据库同步，更多的信息可以在 Flyway 的官网上进行阅读学习。")]),a._v(" "),t("p",[a._v("另外 Flyway 支持很多关系数据库，具体如下所示：")]),a._v(" "),t("p",[t("img",{attrs:{src:"/flyway/Flyway%E6%94%AF%E6%8C%81%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93.png",alt:"Flyway支持的数据库"}})]),a._v(" "),t("h2",{attrs:{id:"使用flyway的好处"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用flyway的好处"}},[a._v("#")]),a._v(" 使用Flyway的好处")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("使用简单")]),a._v(" "),t("p",[a._v("之前进行迁移需要考虑数据库当前状态，脚本是不是被执行过，在这个环境修复的问题，在另一个环境存在吗？现在，只需要一个命令，Flyway就为你完成比较并升级。")])]),a._v(" "),t("li",[t("p",[a._v("很好地解决数据库版本管理和迁移问题")]),a._v(" "),t("p",[a._v("大家遵守共同的规则，我们自己对数据库的改动可以提交，同事对数据库的修改也可以及时知道。")])]),a._v(" "),t("li",[t("p",[a._v("专为CI/CD设计，让持续集成与发布如此简单\n之前反复迭代时，都是数据库手工升级并检查，使用Jenkins完成前后台升级，现在数据库升级也可以集成在流水线了！")])])]),a._v(" "),t("h2",{attrs:{id:"flyway命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#flyway命令"}},[a._v("#")]),a._v(" Flyway命令")]),a._v(" "),t("p",[a._v("Flyway支持的7个命令：")]),a._v(" "),t("ul",[t("li",[a._v("Migrate（迁移）")]),a._v(" "),t("li",[a._v("Clean（清理所有配置的对象）")]),a._v(" "),t("li",[a._v("Info（显示迁移状态和细节）")]),a._v(" "),t("li",[a._v("Validate（验证迁移规则）")]),a._v(" "),t("li",[a._v("Undo（撤消最近的迁移）")]),a._v(" "),t("li",[a._v("Baseline（建立基线）")]),a._v(" "),t("li",[a._v("Repair（修复迁移历史表）")])]),a._v(" "),t("h2",{attrs:{id:"spring-boot集成flyway"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#spring-boot集成flyway"}},[a._v("#")]),a._v(" Spring Boot集成Flyway")]),a._v(" "),t("h3",{attrs:{id:"引入flyway依赖"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#引入flyway依赖"}},[a._v("#")]),a._v(" 引入Flyway依赖")]),a._v(" "),t("p",[a._v("Flyway 几乎是零依赖，最低的要求是：")]),a._v(" "),t("ul",[t("li",[a._v("JDK 1.7+")]),a._v(" "),t("li",[a._v("Jdbc Driver")])]),a._v(" "),t("p",[a._v("首先，在Spring Boot项目的"),t("code",[a._v("pom.xml")]),a._v("文件中引入Flyway所需要的依赖。")]),a._v(" "),t("div",{staticClass:"language-xml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("org.flywaydb"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("flyway-core"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("<")]),a._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("5.2.4"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("</")]),a._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n")])])]),t("h3",{attrs:{id:"添加flyway配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#添加flyway配置"}},[a._v("#")]),a._v(" 添加Flyway配置")]),a._v(" "),t("p",[a._v("然后，在application.yml 中写入 mysql 的配置及 Flyway 的相关配置(Flyway locations 默认读取当前项目下的 resources/db/migration 目录)这里展示flyway有关的配置。")]),a._v(" "),t("div",{staticClass:"language-yml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spring")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("flyway")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("locations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" classpath"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("flyway  "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 用于扫描的迁移脚本目录")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("table")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" t_flyway_history "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 用于记录所有的版本变化记录")]),a._v("\n")])])]),t("p",[a._v("Flyway也是约定大于配置的思想，以上Flyway的相关配置都可以不用写，可以说是零配置，它们都有默认值：")]),a._v(" "),t("ul",[t("li",[a._v("spring.flyway.locations: classpath:db/migration，用于扫描的迁移脚本目录")]),a._v(" "),t("li",[a._v("spring.flyway.table: flyway_schema_history，用于记录所有的版本变化记录")])]),a._v(" "),t("p",[a._v("Migrate 是指把数据库 schema 迁移到最新版本，是 flyway 工作流的核心功能， flyway 在 Migrate 时会检查 flyway_schema_history 表，如果不存在会创建 flyway_schema_history 表， flyway_schema_history 表主要用于记录版本变更历史以及 checksum 之类的。")]),a._v(" "),t("h3",{attrs:{id:"创建迁移脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建迁移脚本"}},[a._v("#")]),a._v(" 创建迁移脚本")]),a._v(" "),t("p",[a._v("接下来，在"),t("code",[a._v("spring.flyway.locations")]),a._v("指定的目录下创建迁移脚本，若是初次使用，需要在resources目录下创建"),t("code",[a._v("spring.flyway.locations")]),a._v("指定的目录。其中，SQL 脚本命名规范如下：")]),a._v(" "),t("p",[t("img",{attrs:{src:"/flyway/Flyway%E8%84%9A%E6%9C%AC%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83.png",alt:"Flyway支持的数据库"}})]),a._v(" "),t("ul",[t("li",[a._v("Prefix 前缀：V 代表版本迁移，U 代表撤销迁移，R 代表可重复迁移")]),a._v(" "),t("li",[a._v("Version 版本号：版本号通常由 . 和整数组成")]),a._v(" "),t("li",[a._v("Separator 分隔符：固定由两个下划线 __ 组成")]),a._v(" "),t("li",[a._v("Description 描述：由下划线分隔的单词组成，用于描述本次迁移的目的")]),a._v(" "),t("li",[a._v("Suffix 后缀：如果是 SQL 文件那么固定由 .sql 组成，如果是基于 Java 类则默认不需要后缀。")])]),a._v(" "),t("p",[a._v("启动项目后，Flyway执行了数据库脚本，并自动创建"),t("code",[a._v("spring.flyway.table")]),a._v("指定的数据库表，用于记录所有版本演化和状态，同时，Flyway 会给脚本计算一个 checksum 保存在数据库中，用于在之后运行过程中对比 sql 文件是否有变化，如果发生了变化，则会报错，防止误修改脚本导致发生问题。其表结构如下(以 MySQL 为例)：")]),a._v(" "),t("p",[t("img",{attrs:{src:"/flyway/Flyway%E8%AE%B0%E5%BD%95%E8%A1%A8%E7%BB%93%E6%9E%84.png",alt:"Flyway记录表结构"}})]),a._v(" "),t("h2",{attrs:{id:"flyway迁移流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#flyway迁移流程"}},[a._v("#")]),a._v(" Flyway迁移流程")]),a._v(" "),t("p",[a._v("1）Flyway 会扫描配置的脚本目录下的脚本文件；")]),a._v(" "),t("p",[a._v("2）如果历史记录表不存在，则新建历史记录表；")]),a._v(" "),t("p",[a._v("3）如果是一次性执行脚本（V），按版本号从小到大执行迁移脚本，与当前历史表中的版本号做对比，大于当前版本号的脚本才会被执行迁移；")]),a._v(" "),t("p",[a._v("4）如果是可重复执行脚本（R），检查脚本是否有变动，有变动的可重复脚本才会被执行迁移；")])])}),[],!1,null,null,null);t.default=r.exports}}]);