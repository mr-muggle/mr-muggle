(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{676:function(s,t,a){"use strict";a.r(t);var e=a(74),r=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"触发器的基本概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#触发器的基本概念"}},[s._v("#")]),s._v(" 触发器的基本概念")]),s._v(" "),t("p",[s._v("数据库触发器是一个与表相关联的、存储的PL/SQL程序。当一个特定的数据操纵语句（insert、update、delete）在指定的表发出时，Oracle会自动地执行触发器中定义地语句序列。")]),s._v(" "),t("h2",{attrs:{id:"触发器的类型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#触发器的类型"}},[s._v("#")]),s._v(" 触发器的类型")]),s._v(" "),t("p",[s._v("在Oracle数据库中，有两种类型的触发器：语句级触发器和行级触发器。")]),s._v(" "),t("ul",[t("li",[s._v("语句级触发器：在指定的操作语句操作之前或之后执行一次，不管这条语句影响了多少行。")]),s._v(" "),t("li",[s._v("行级触发器：触发语句作用的每一句记录都被触发。在行级触发器中使用"),t("code",[s._v(":old")]),s._v("和"),t("code",[s._v(":new")]),s._v("伪记录变量，识别值的状态。")])]),s._v(" "),t("h2",{attrs:{id:"触发器的基本语法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#触发器的基本语法"}},[s._v("#")]),s._v(" 触发器的基本语法")]),s._v(" "),t("div",{staticClass:"language-plsql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-plsql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("or")]),s._v(" replace"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" trigger 触发器名\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 在增删改执行前还是执行后")]),s._v("\n{after|before} {"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v("|"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("delete")]),s._v("|"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("of")]),s._v(" 列名"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("} "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" 表名\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" each "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("条件"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nPLSQL块\n")])])]),t("h2",{attrs:{id:"触发器的作用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#触发器的作用"}},[s._v("#")]),s._v(" 触发器的作用")]),s._v(" "),t("p",[s._v("一般来讲，触发器主要使用在以下场景：")]),s._v(" "),t("ul",[t("li",[s._v("复杂的安全性检查")]),s._v(" "),t("li",[s._v("数据确认")]),s._v(" "),t("li",[s._v("实现审计功能")]),s._v(" "),t("li",[s._v("完成数据的备份与同步")])]),s._v(" "),t("p",[s._v("下面，我们来举两个例子。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("复杂的安全检查：例如禁止在周末和非工作时间插入数据。")]),s._v(" "),t("div",{staticClass:"language-plsql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-plsql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("or")]),s._v(" replace trigger securityemp\nbefore "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" emp\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" to_char"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sysdate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'day'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'星期六'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'星期日'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("or")]),s._v(" to_number"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("to_char"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sysdate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hh24'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("between")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("and")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 由于我们不是抛出数据库错误，而是在PL/SQL中抛出异常。因此，不使用raise关键字，而是使用函数抛出错误编码和信息")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 自定义错误编码必须在-20000到-20999")]),s._v("\nraise_application_error"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20001")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'禁止在非工作时间插入新员工'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])])]),s._v(" "),t("li",[t("p",[s._v("数据的确认：例如涨薪后的薪水不能少于涨后的薪水，由于我们需要对每一条数据进行检查，因此需要使用行级触发器。")]),s._v(" "),t("div",{staticClass:"language-plsql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-plsql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("or")]),s._v(" replace trigger checksalary\nbefore "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" emp\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" each "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" 涨后的薪水"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("涨前的薪水 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n raise_application_error"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20002")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'涨后的薪水不能少于涨前的薪水'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("为了表示涨后的薪水和涨前的薪水，我们需要使用前面提到的"),t("code",[s._v(":old")]),s._v("和"),t("code",[s._v(":new")]),s._v("伪记录变量，通过这两个变量完成判断。需要注意的是，")]),s._v(" "),t("ul",[t("li",[t("code",[s._v(":old")]),s._v("和"),t("code",[s._v(":new")]),s._v("表示同一条记录")]),s._v(" "),t("li",[t("code",[s._v(":old")]),s._v("表示操作该行之前，这一行的值")]),s._v(" "),t("li",[t("code",[s._v(":new")]),s._v("表示操作改行之后，这一行的值")])]),s._v(" "),t("p",[s._v("于是，我们如下这样编写代码")]),s._v(" "),t("div",{staticClass:"language-plsql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-plsql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("or")]),s._v(" replace trigger checksalary\nbefore "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" emp\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" each "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sal"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("old")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sal "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  raise_application_error"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20002")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'涨后的薪水不能少于涨前的薪水'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'涨后的薪水:'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sal "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'涨前的薪水'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("old")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("通过上面的例子，我们已经掌握了触发器的基本使用方法。")])])])])}),[],!1,null,null,null);t.default=r.exports}}]);