<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Redis客户端 | Knowledge</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" href="/mr-mugglefavicon.ico">
    <meta name="description" content="talk is cheap show me the code">
    <link rel="preload" href="/mr-muggle/assets/css/0.styles.a4a1d2b1.css" as="style"><link rel="preload" href="/mr-muggle/assets/js/app.03b0f33a.js" as="script"><link rel="preload" href="/mr-muggle/assets/js/2.c49e4524.js" as="script"><link rel="preload" href="/mr-muggle/assets/js/33.cbdbae4d.js" as="script"><link rel="prefetch" href="/mr-muggle/assets/js/10.b769111d.js"><link rel="prefetch" href="/mr-muggle/assets/js/11.3b528e8b.js"><link rel="prefetch" href="/mr-muggle/assets/js/12.262bc424.js"><link rel="prefetch" href="/mr-muggle/assets/js/13.701f9444.js"><link rel="prefetch" href="/mr-muggle/assets/js/14.f5836d8f.js"><link rel="prefetch" href="/mr-muggle/assets/js/15.f6ae0270.js"><link rel="prefetch" href="/mr-muggle/assets/js/16.88f016bf.js"><link rel="prefetch" href="/mr-muggle/assets/js/17.2cb6dc15.js"><link rel="prefetch" href="/mr-muggle/assets/js/18.190ccd99.js"><link rel="prefetch" href="/mr-muggle/assets/js/19.5b842041.js"><link rel="prefetch" href="/mr-muggle/assets/js/20.23e5f14f.js"><link rel="prefetch" href="/mr-muggle/assets/js/21.76eb19cf.js"><link rel="prefetch" href="/mr-muggle/assets/js/22.9a998e87.js"><link rel="prefetch" href="/mr-muggle/assets/js/23.d79bc80a.js"><link rel="prefetch" href="/mr-muggle/assets/js/24.68b1ece9.js"><link rel="prefetch" href="/mr-muggle/assets/js/25.0536eb3c.js"><link rel="prefetch" href="/mr-muggle/assets/js/26.e1e22d1b.js"><link rel="prefetch" href="/mr-muggle/assets/js/27.10fbd948.js"><link rel="prefetch" href="/mr-muggle/assets/js/28.9d8bf67a.js"><link rel="prefetch" href="/mr-muggle/assets/js/29.959e32d1.js"><link rel="prefetch" href="/mr-muggle/assets/js/3.4c2c33d8.js"><link rel="prefetch" href="/mr-muggle/assets/js/30.98fcced0.js"><link rel="prefetch" href="/mr-muggle/assets/js/31.c3717be1.js"><link rel="prefetch" href="/mr-muggle/assets/js/32.04594faa.js"><link rel="prefetch" href="/mr-muggle/assets/js/34.112b9f11.js"><link rel="prefetch" href="/mr-muggle/assets/js/35.b52ec603.js"><link rel="prefetch" href="/mr-muggle/assets/js/36.6a59af48.js"><link rel="prefetch" href="/mr-muggle/assets/js/37.7974b0c2.js"><link rel="prefetch" href="/mr-muggle/assets/js/38.f998387a.js"><link rel="prefetch" href="/mr-muggle/assets/js/39.89abf77c.js"><link rel="prefetch" href="/mr-muggle/assets/js/4.8c3e511b.js"><link rel="prefetch" href="/mr-muggle/assets/js/40.ec4c57c4.js"><link rel="prefetch" href="/mr-muggle/assets/js/41.ef41848b.js"><link rel="prefetch" href="/mr-muggle/assets/js/42.8538a508.js"><link rel="prefetch" href="/mr-muggle/assets/js/43.c712f5fa.js"><link rel="prefetch" href="/mr-muggle/assets/js/44.7e2435a1.js"><link rel="prefetch" href="/mr-muggle/assets/js/45.633f2d43.js"><link rel="prefetch" href="/mr-muggle/assets/js/46.1bd7c05d.js"><link rel="prefetch" href="/mr-muggle/assets/js/47.e5df90ad.js"><link rel="prefetch" href="/mr-muggle/assets/js/48.cd6c7156.js"><link rel="prefetch" href="/mr-muggle/assets/js/49.90631ebb.js"><link rel="prefetch" href="/mr-muggle/assets/js/5.6834c560.js"><link rel="prefetch" href="/mr-muggle/assets/js/50.9f214f89.js"><link rel="prefetch" href="/mr-muggle/assets/js/51.99a8dd78.js"><link rel="prefetch" href="/mr-muggle/assets/js/52.aec5051a.js"><link rel="prefetch" href="/mr-muggle/assets/js/53.7b621de8.js"><link rel="prefetch" href="/mr-muggle/assets/js/54.aa323f86.js"><link rel="prefetch" href="/mr-muggle/assets/js/55.63b233d9.js"><link rel="prefetch" href="/mr-muggle/assets/js/56.2cc8fe7b.js"><link rel="prefetch" href="/mr-muggle/assets/js/57.2a7a35c6.js"><link rel="prefetch" href="/mr-muggle/assets/js/58.3ef9ff2d.js"><link rel="prefetch" href="/mr-muggle/assets/js/59.4194402f.js"><link rel="prefetch" href="/mr-muggle/assets/js/6.ad05d8e5.js"><link rel="prefetch" href="/mr-muggle/assets/js/60.01275a59.js"><link rel="prefetch" href="/mr-muggle/assets/js/61.d314066d.js"><link rel="prefetch" href="/mr-muggle/assets/js/62.68ce6bc5.js"><link rel="prefetch" href="/mr-muggle/assets/js/63.34dea9e0.js"><link rel="prefetch" href="/mr-muggle/assets/js/64.9aaf5e00.js"><link rel="prefetch" href="/mr-muggle/assets/js/65.e4ce25ad.js"><link rel="prefetch" href="/mr-muggle/assets/js/66.5d9f1db5.js"><link rel="prefetch" href="/mr-muggle/assets/js/67.c914fc65.js"><link rel="prefetch" href="/mr-muggle/assets/js/68.5ee52c48.js"><link rel="prefetch" href="/mr-muggle/assets/js/69.680accb1.js"><link rel="prefetch" href="/mr-muggle/assets/js/7.0c092304.js"><link rel="prefetch" href="/mr-muggle/assets/js/70.cf4408b5.js"><link rel="prefetch" href="/mr-muggle/assets/js/71.33ad3ca9.js"><link rel="prefetch" href="/mr-muggle/assets/js/72.87880929.js"><link rel="prefetch" href="/mr-muggle/assets/js/73.11b998f6.js"><link rel="prefetch" href="/mr-muggle/assets/js/74.5a75b187.js"><link rel="prefetch" href="/mr-muggle/assets/js/75.5301781a.js"><link rel="prefetch" href="/mr-muggle/assets/js/76.c446bc20.js"><link rel="prefetch" href="/mr-muggle/assets/js/77.4eaa9052.js"><link rel="prefetch" href="/mr-muggle/assets/js/78.3b98b54f.js"><link rel="prefetch" href="/mr-muggle/assets/js/79.60b9a9ba.js"><link rel="prefetch" href="/mr-muggle/assets/js/8.471386f2.js"><link rel="prefetch" href="/mr-muggle/assets/js/80.7b067e03.js"><link rel="prefetch" href="/mr-muggle/assets/js/81.8274f49e.js"><link rel="prefetch" href="/mr-muggle/assets/js/82.b72070ad.js"><link rel="prefetch" href="/mr-muggle/assets/js/83.4651609d.js"><link rel="prefetch" href="/mr-muggle/assets/js/84.fffdd780.js"><link rel="prefetch" href="/mr-muggle/assets/js/85.10865df0.js"><link rel="prefetch" href="/mr-muggle/assets/js/86.5b4b0452.js"><link rel="prefetch" href="/mr-muggle/assets/js/87.a270ec2b.js"><link rel="prefetch" href="/mr-muggle/assets/js/88.8bb08b0f.js"><link rel="prefetch" href="/mr-muggle/assets/js/89.3826a944.js"><link rel="prefetch" href="/mr-muggle/assets/js/9.d8124a2e.js"><link rel="prefetch" href="/mr-muggle/assets/js/90.dbf7dede.js"><link rel="prefetch" href="/mr-muggle/assets/js/91.0823b62f.js"><link rel="prefetch" href="/mr-muggle/assets/js/92.8ec406ed.js">
    <link rel="stylesheet" href="/mr-muggle/assets/css/0.styles.a4a1d2b1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="nav-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-6 ant-col-xl-5 ant-col-xxl-4"><a href="/mr-muggle/" class="router-link-active no-logo home-link"><!----> <span class="site-name">Knowledge</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="nav-space-between ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-18 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/mr-muggle/" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          后端开发必知必会
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          前端开发必知必会
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          数据库
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          消息队列
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          搜索引擎
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          项目部署与运维
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          办公软件
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <ul class="extra-group"><!----> <!----></ul></nav></div></div> <!----></header> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/mr-muggle/数据库/Redis/初识Redis.html" title="初识 Redis" class="sidebar-link">初识 Redis</a></li><li><a href="/mr-muggle/数据库/Redis/API的理解和使用.html" title="API的理解和使用" class="sidebar-link">API的理解和使用</a></li><li><a href="/mr-muggle/数据库/Redis/Redis的一些有用的小功能.html" title="Redis的一些有用的小功能" class="sidebar-link">Redis的一些有用的小功能</a></li><li><a href="/mr-muggle/数据库/Redis/Redis客户端.html" title="Redis客户端" class="active sidebar-link">Redis客户端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#redis客户端的意义" title="Redis客户端的意义" class="sidebar-link">Redis客户端的意义</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端通信协议" title="客户端通信协议" class="sidebar-link">客户端通信协议</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端协议定义的发送命令格式" title="客户端协议定义的发送命令格式" class="sidebar-link">客户端协议定义的发送命令格式</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端协议定义的返回结果格式" title="客户端协议定义的返回结果格式" class="sidebar-link">客户端协议定义的返回结果格式</a></li></ul></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#java客户端-jedis" title="Java客户端-Jedis" class="sidebar-link">Java客户端-Jedis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#获取jedis" title="获取Jedis" class="sidebar-link">获取Jedis</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#jedis的基本使用方法" title="Jedis的基本使用方法" class="sidebar-link">Jedis的基本使用方法</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#jedis连接池的使用方法" title="Jedis连接池的使用方法" class="sidebar-link">Jedis连接池的使用方法</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#直连和连接池方式的优缺点" title="直连和连接池方式的优缺点" class="sidebar-link">直连和连接池方式的优缺点</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#连接池方式使用jedis" title="连接池方式使用Jedis" class="sidebar-link">连接池方式使用Jedis</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#jedis使用pipeline" title="Jedis使用Pipeline" class="sidebar-link">Jedis使用Pipeline</a></li></ul></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#redis客户端管理" title="Redis客户端管理" class="sidebar-link">Redis客户端管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端标识" title="客户端标识" class="sidebar-link">客户端标识</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#输入缓冲区" title="输入缓冲区" class="sidebar-link">输入缓冲区</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#输出缓冲区" title="输出缓冲区" class="sidebar-link">输出缓冲区</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端的存活状态" title="客户端的存活状态" class="sidebar-link">客户端的存活状态</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端的限制maxclients和timeout" title="客户端的限制maxclients和timeout" class="sidebar-link">客户端的限制maxclients和timeout</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端类型" title="客户端类型" class="sidebar-link">客户端类型</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#设置和获取客户端名称" title="设置和获取客户端名称" class="sidebar-link">设置和获取客户端名称</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#杀掉指定ip地址和端口的客户端" title="杀掉指定IP地址和端口的客户端" class="sidebar-link">杀掉指定IP地址和端口的客户端</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#阻塞客户端连接" title="阻塞客户端连接" class="sidebar-link">阻塞客户端连接</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#监控redis正在执行的命令" title="监控Redis正在执行的命令" class="sidebar-link">监控Redis正在执行的命令</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端相关配置" title="客户端相关配置" class="sidebar-link">客户端相关配置</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端统计片段" title="客户端统计片段" class="sidebar-link">客户端统计片段</a></li></ul></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端常见异常" title="客户端常见异常" class="sidebar-link">客户端常见异常</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#无法从连接池获取到连接" title="无法从连接池获取到连接" class="sidebar-link">无法从连接池获取到连接</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端读写超时" title="客户端读写超时" class="sidebar-link">客户端读写超时</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端连接超时" title="客户端连接超时" class="sidebar-link">客户端连接超时</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端缓冲区异常" title="客户端缓冲区异常" class="sidebar-link">客户端缓冲区异常</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#redis正在加载持久化文件" title="Redis正在加载持久化文件" class="sidebar-link">Redis正在加载持久化文件</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#redis使用的内存超过maxmemory配置" title="Redis使用的内存超过maxmemory配置" class="sidebar-link">Redis使用的内存超过maxmemory配置</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis客户端.html#客户端连接数过大" title="客户端连接数过大" class="sidebar-link">客户端连接数过大</a></li></ul></li></ul></li><li><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html" title="Redis的两种持久化机制" class="sidebar-link">Redis的两种持久化机制</a></li><li><a href="/mr-muggle/数据库/Redis/Redis复制配置与原理.html" title="Redis复制配置与原理" class="sidebar-link">Redis复制配置与原理</a></li><li><a href="/mr-muggle/数据库/Redis/Redis阻塞原因与处理.html" title="Redis阻塞原因与处理" class="sidebar-link">Redis阻塞原因与处理</a></li><li><a href="/mr-muggle/数据库/Redis/Redis内存管理与优化.html" title="Redis内存管理与优化" class="sidebar-link">Redis内存管理与优化</a></li></ul> </aside> <main class="page has-page-anchor"> <div class="theme-antdocs-content content__default"><h2 id="redis客户端的意义"><a href="#redis客户端的意义" class="header-anchor">#</a> Redis客户端的意义</h2> <p>Redis是用单线程来处理多个客户端的访问，因此，作为Redis的开发和运维人员需要了解Redis服务端和客户端的通信协议，以及主流编程语言的Redis客户端使用方法，同时还需要了解客户端管理的相应API以及开发运维中可能遇到的问题。</p> <h2 id="客户端通信协议"><a href="#客户端通信协议" class="header-anchor">#</a> 客户端通信协议</h2> <p>几乎所有的主流编程语言都有Redis的客户端（http://redis.io/clients），站在技术的角度看原因有两个：</p> <ul><li>客户端与服务端之间的通信协议是在TCP协议之上构建的。</li> <li>Redis制定了RESP（REdis Serialization Protocol，Redis序列化协议）实现客户端与服务端的正常交互，这种协议简单高效，既能够被机器解析，又容易被人类识别。</li></ul> <p>例如客户端发送一条<code>set hello world</code>命令给服务端，按照RESP的标准，客户端需要将其封装为如下格式（每行用\r\n分隔）。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>*3
<span class="token variable">$3</span>
SET
<span class="token variable">$5</span>
hello
<span class="token variable">$5</span>
world
</code></pre></div><p>这样Redis服务端能够按照RESP将其解析为<code>set hello world</code>命令，执行后回复的格式如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>+OK
</code></pre></div><p>可以看到除了命令（set hello world）和返回结果（OK）本身还包含了一些特殊字符以及数字，下面将对这些格式进行说明。</p> <h3 id="客户端协议定义的发送命令格式"><a href="#客户端协议定义的发送命令格式" class="header-anchor">#</a> 客户端协议定义的发送命令格式</h3> <p>RESP的规定一条命令的格式如下，CRLF代表&quot;\r\n&quot;。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>*<span class="token operator">&lt;</span>参数数量<span class="token operator">&gt;</span> CRLF
<span class="token number">248</span>
$<span class="token operator">&lt;</span>参数1的字节数量<span class="token operator">&gt;</span> CRLF
<span class="token operator">&lt;</span>参数<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> CRLF
<span class="token punctuation">..</span>.
$<span class="token operator">&lt;</span>参数N的字节数量<span class="token operator">&gt;</span> CRLF
<span class="token operator">&lt;</span>参数N<span class="token operator">&gt;</span> CRLF
</code></pre></div><p>以<code>set hello world</code>命令进行说明，参数数量为3，所以，第一行显示：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>*3
</code></pre></div><p>后面参数的字节数分别是355，因此后面几行为：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token variable">$3</span>
SET
<span class="token variable">$5</span>
hello
<span class="token variable">$5</span>
world
</code></pre></div><p>需要注意的是，上面只是格式化显示的结果，实际传输格式为如下代码：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>*3<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$3</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nSET<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$5</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nhello<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$5</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nworld<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n
</code></pre></div><h3 id="客户端协议定义的返回结果格式"><a href="#客户端协议定义的返回结果格式" class="header-anchor">#</a> 客户端协议定义的返回结果格式</h3> <p>Redis的返回结果类型分为以下五种：</p> <ul><li>状态回复：在RESP中第一个字节为&quot;+&quot;</li> <li>错误回复：在RESP中第一个字节为&quot;-&quot;</li> <li>整数回复：在RESP中第一个字节为&quot;：&quot;</li> <li>字符串回复：在RESP中第一个字节为&quot;$&quot;</li> <li>多条字符串回复：在RESP中第一个字节为&quot;*&quot;</li></ul> <p>我们知道redis-cli只能看到最终的执行结果，那是因为redis-cli本身就是按照RESP进行结果解析的，所以看不到中间结果，redis-cli.c源码对命令结果的解析结构如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>static sds cliFormatReplyTTY<span class="token punctuation">(</span>redisReply *r, char *prefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
sds out <span class="token operator">=</span> sdsempty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
switch <span class="token punctuation">(</span>r-<span class="token operator">&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">case</span> REDIS_REPLY_ERROR:
// 处理错误回复
<span class="token keyword">case</span> REDIS_REPLY_STATUS:
// 处理状态回复
<span class="token keyword">case</span> REDIS_REPLY_INTEGER:
// 处理整数回复
<span class="token keyword">case</span> REDIS_REPLY_STRING:
// 处理字符串回复
<span class="token keyword">case</span> REDIS_REPLY_NIL:
// 处理空
<span class="token keyword">case</span> REDIS_REPLY_ARRAY:
// 处理多条字符串回复
<span class="token builtin class-name">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为了看到Redis服务端返回的“真正”结果，可以使用<code>nc</code>命令、<code>telnet</code>命令、甚至写一个socket程序进行模拟。下面以<code>nc</code>命令进行演示，首先使用nc127.0.0.16379连接到Redis：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">6379</span>
</code></pre></div><p>若提示命令不存在，则需要安装<code>nc</code>命令。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">nc</span>
</code></pre></div><h4 id="状态回复"><a href="#状态回复" class="header-anchor">#</a> 状态回复</h4> <p>状态回复：：set hello world的返回结果为+OK：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">set</span> hello world
+OK
</code></pre></div><h4 id="错误回复"><a href="#错误回复" class="header-anchor">#</a> 错误回复</h4> <p>错误回复：由于sethx这条命令不存在，那么返回结果就是&quot;-&quot;号加上错误消息：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>sethx
<span class="token parameter variable">-ERR</span> unknown <span class="token builtin class-name">command</span> <span class="token variable"><span class="token variable">`</span>sethx<span class="token variable">`</span></span>, with args beginning with: 
</code></pre></div><h4 id="整数回复"><a href="#整数回复" class="header-anchor">#</a> 整数回复</h4> <p>整数回复：当命令的执行结果是整数时，返回结果就是整数回复，例如<code>incr</code>、<code>exists</code>、<code>del</code>、<code>dbsize</code>返回结果都是整数，例如执行incr counter返回结果就是“：”加上整数：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>incr counter
:1
</code></pre></div><h4 id="字符串回复"><a href="#字符串回复" class="header-anchor">#</a> 字符串回复</h4> <p>字符串回复：当命令的执行结果是字符串时，返回结果就是字符串回复。例如<code>get</code>、<code>hget</code>返回结果都是字符串，例如<code>get hello</code>的结果。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>get hello
<span class="token variable">$5</span>
world
</code></pre></div><h4 id="多条字符串回复"><a href="#多条字符串回复" class="header-anchor">#</a> 多条字符串回复</h4> <p>多条字符串回复：当命令的执行结果是多条字符串时，返回结果就是多条字符串回复。例如<code>mget</code>、<code>hgetall</code>、<code>lrange</code>等命令会返回多个结果，例如下面操作：</p> <p>首先使用<code>mset</code>命令设置多个键值对：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>mset <span class="token function">java</span> jedis python redis-py
+OK
</code></pre></div><p>然后执行mget命令返回多个结果，第一个*2代表返回结果的个数，后面的格式是和字符串回复一致的。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>mget <span class="token function">java</span> python
*2
<span class="token variable">$5</span>
jedis
<span class="token variable">$8</span>
redis-py

</code></pre></div><p><strong>有一点需要注意，无论是字符串回复还是多条字符串回复，如果有nil值，那么会返回$-1。</strong> 例如，对一个不存在的键执行get操作，返回结果为：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>get not_exist_key
$-1
</code></pre></div><p>如果批量操作中包含一条为nil值的结果，那么返回结果如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>mget hello not_exist_key <span class="token function">java</span>
*3
<span class="token variable">$5</span>
world
$-1
<span class="token variable">$5</span>
jedis
</code></pre></div><h2 id="java客户端-jedis"><a href="#java客户端-jedis" class="header-anchor">#</a> Java客户端-Jedis</h2> <p>Java有很多优秀的Redis客户端（详见：http://redis.io/clients#java），这里介绍使用较为广泛的客户端Jedis。</p> <h3 id="获取jedis"><a href="#获取jedis" class="header-anchor">#</a> 获取Jedis</h3> <p>Jedis属于Java的第三方开发包，在Java中获取第三方开发包通常有两种方式：</p> <ul><li>直接下载目标版本的Jedis-${version}.jar包加入到项目中。</li> <li>使用集成构建工具，例如maven、gradle等将Jedis目标版本的配置加入到项目中。</li></ul> <p>通常在实际项目中使用第二种方式，但如果只是想测试一下Jedis，第一种方法也是可以的。以Maven为例子，在项目中加入下面的依赖即可。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.8.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>对于第三方开发包，版本的选择也是至关重要的，因为Redis更新速度比较快，如果客户端跟不上服务端的速度，有些特性和bug不能及时更新，不利于日常开发。通常来讲选取第三方开发包有如下两个策略：</p> <ul><li>选择比较稳定的版本，也就是尽可能选择稳定的里程碑版本，这些版本已经经过多次alpha，beta的修复，基本算是稳定了。</li> <li>选择更新活跃的第三方开发包，例如Redis3.0有了Redis Cluster新特性，但是如果使用的客户端一直不支持，并且维护的人也比较少，这种就谨慎选择。</li></ul></div> <h3 id="jedis的基本使用方法"><a href="#jedis的基本使用方法" class="header-anchor">#</a> Jedis的基本使用方法</h3> <p>Jedis的使用方法非常简单，只要下面三行代码就可以实现get功能：</p> <div class="language-java extra-class"><pre class="language-java"><code># <span class="token number">1.</span> 生成一个<span class="token class-name">Jedis</span>对象，这个对象负责和指定<span class="token class-name">Redis</span>实例进行通信
<span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
# <span class="token number">2.</span> jedis执行set操作
jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
# <span class="token number">3.</span> jedis执行get操作<span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">&quot;world&quot;</span>
<span class="token class-name">String</span> value <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到初始化Jedis需要两个参数：Redis实例的IP和端口，除了这两个参数外，还有一个包含了四个参数的构造函数是比较常用的。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> connectionTimeout<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span>
soTimeout<span class="token punctuation">)</span>
</code></pre></div><p>各个参数的含义如下：</p> <ul><li>host：Redis实例的所在机器的IP</li> <li>port：Redis实例的端口</li> <li>connectionTimeout：客户端连接超时</li> <li>soTimeout：客户端读写超时</li></ul> <p>下面我们尝试使用一下Jedis字符串命令</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> setResult <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> getResult <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>setResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>getResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>输出结果为：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>OK
world
</code></pre></div><p>可以看到jedis.set的返回结果是OK，和redis-cli的执行效果是一样的，只不过结果类型变为了Java的数据类型。上面的这种写法只是为了演示使用，在实际项目中比较推荐使用try catch finally的形式来进行代码的书写，主要有以下两点理由：</p> <ul><li>一方面可以在Jedis出现异常的时候（本身是网络操作），将异常进行捕获或者抛出。</li> <li>另一个方面无论执行成功或者失败，将Jedis连接关闭掉，在开发中关闭不用的连接资源是一种好的习惯。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
	jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面是Jedis对5种数据结构的基本使用方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 1.string</span>
<span class="token comment">// 输出结果：OK</span>
jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出结果：world</span>
jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出结果：1</span>
jedis<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token string">&quot;counter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2.hash</span>
jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">&quot;myhash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;f1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">&quot;myhash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;f2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出结果：{f1=v1, f2=v2}</span>
jedis<span class="token punctuation">.</span><span class="token function">hgetAll</span><span class="token punctuation">(</span><span class="token string">&quot;myhash&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3.list</span>
jedis<span class="token punctuation">.</span><span class="token function">rpush</span><span class="token punctuation">(</span><span class="token string">&quot;mylist&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jedis<span class="token punctuation">.</span><span class="token function">rpush</span><span class="token punctuation">(</span><span class="token string">&quot;mylist&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jedis<span class="token punctuation">.</span><span class="token function">rpush</span><span class="token punctuation">(</span><span class="token string">&quot;mylist&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">258</span>
<span class="token comment">// 输出结果：[1, 2, 3]</span>
jedis<span class="token punctuation">.</span><span class="token function">lrange</span><span class="token punctuation">(</span><span class="token string">&quot;mylist&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 4.set</span>
jedis<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">&quot;myset&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jedis<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">&quot;myset&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jedis<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span><span class="token string">&quot;myset&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出结果：[b, a]</span>
jedis<span class="token punctuation">.</span><span class="token function">smembers</span><span class="token punctuation">(</span><span class="token string">&quot;myset&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 5.zset</span>
jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">&quot;myzset&quot;</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token string">&quot;tom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">&quot;myzset&quot;</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token string">&quot;peter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jedis<span class="token punctuation">.</span><span class="token function">zadd</span><span class="token punctuation">(</span><span class="token string">&quot;myzset&quot;</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token string">&quot;james&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出结果：[[[&quot;james&quot;],33.0], [[&quot;peter&quot;],66.0], [[&quot;tom&quot;],99.0]]</span>
jedis<span class="token punctuation">.</span><span class="token function">zrangeWithScores</span><span class="token punctuation">(</span><span class="token string">&quot;myzset&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>参数除了可以是字符串，Jedis还提供了字节数组的参数，例如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span>
</code></pre></div><p>有了这些API的支持，就可以将Java对象序列化为二进制，当应用需要获取Java对象时，使用get（final byte[]key）函数将字节数组取出，然后反序列化为Java对象即可。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>和很多NoSQL数据库（例如Memcache、Ehcache）的客户端不同，Jedis本身没有提供序列化的工具，开发者需要自己引入序列化的工具，一般我们将其序列化为Json字符串，通过Gson等Json相关依赖提供序列化和反序列化功能。</p></div> <h3 id="jedis连接池的使用方法"><a href="#jedis连接池的使用方法" class="header-anchor">#</a> Jedis连接池的使用方法</h3> <p>在上一节中，我们使用的是Jedis的直连方式，所谓直连是指Jedis每次都会新建TCP连接，使用后再断开连接，对于频繁访问Redis的场景显然不是高效的使用方式。</p> <p>因此生产环境中一般使用连接池的方式对Jedis连接进行管理，所有Jedis对象预先放在池子中（JedisPool），每次要连接Redis，只需要在池子中借用即可，用完后再将Jedis对象归还给池子。</p> <h3 id="直连和连接池方式的优缺点"><a href="#直连和连接池方式的优缺点" class="header-anchor">#</a> 直连和连接池方式的优缺点</h3> <p>客户端连接Redis使用的是TCP协议，直连的方式每次需要建立TCP连接，而连接池的方式是可以预先初始化Jedis连接，所以每次只需要从Jedis连接池借用即可，而借用和归还操作是在本地进行的，只有少量的并发同步开销，远远小于新建TCP连接的开销。另外直连的方式无法限制Jedis对象的个数，在极端情况下可能会造成连接泄露，而连接池的形式可以有效的保护和控制资源的使用。</p> <p>下表我们将列出直连和使用连接池方式的优缺点。</p> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">优点</th> <th style="text-align:center;">缺点</th></tr></thead> <tbody><tr><td style="text-align:center;">直连</td> <td style="text-align:center;">简单方便，适用于少量长期连接的情况</td> <td style="text-align:center;">存在每次需要连接/关闭TCP连接开销的情况 <br>资源无法控制，极端情况会出现连接泄漏<br> Jedis对象线程不安全</td></tr> <tr><td style="text-align:center;">连接池</td> <td style="text-align:center;">无需每次都生成redis对象，降低开销<br>使用连接池的形式保护和控制资源的使用</td> <td style="text-align:center;"></td></tr></tbody></table> <h3 id="连接池方式使用jedis"><a href="#连接池方式使用jedis" class="header-anchor">#</a> 连接池方式使用Jedis</h3> <p>Jedis提供了JedisPool这个类作为对Jedis的连接池，同时使用了Apache的通用对象池工具common-pool作为资源的管理工具，下面是使用JedisPool操作Redis的代码示例：</p> <h4 id="配置jedis连接池"><a href="#配置jedis连接池" class="header-anchor">#</a> 配置Jedis连接池</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// common-pool连接池配置，这里使用默认配置，后面小节会介绍具体配置说明</span>
<span class="token class-name">GenericObjectPoolConfig</span> poolConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericObjectPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化Jedis连接池</span>
<span class="token class-name">JedisPool</span> jedisPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>poolConfig<span class="token punctuation">,</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="获取jedis对象并使用"><a href="#获取jedis对象并使用" class="header-anchor">#</a> 获取Jedis对象并使用</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token comment">// 1. 从连接池获取jedis对象</span>
jedis <span class="token operator">=</span> jedisPool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2. 执行操作</span>
jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 如果使用JedisPool，close操作不是关闭连接，代表归还连接池</span>
jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里可以看到在finally中依然是<code>jedis.close()</code>操作，为什么会把连接关闭呢，这不和连接池的原则违背了吗？但实际上Jedis的<code>close()</code>方法实现方式如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 使用Jedis连接池</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>dataSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">isBroken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 直连</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>针对这段代码，我们进行参数说明：</p> <ul><li><p>dataSource！=null代表使用的是连接池，所以jedis.close（）代表归还连接给连接池，而且Jedis会判断当前连接是否已经断开。</p></li> <li><p>dataSource=null代表直连，jedis.close（）代表关闭连接。</p></li></ul> <h4 id="jedis连接池常用的配置"><a href="#jedis连接池常用的配置" class="header-anchor">#</a> Jedis连接池常用的配置</h4> <p>前面我们使用的是GenericObjectPoolConfig的默认配置，实际它提供了很多参数：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">GenericObjectPoolConfig</span> poolConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericObjectPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置最大连接数为默认值的5倍</span>
poolConfig<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span><span class="token class-name">GenericObjectPoolConfig</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_MAX_TOTAL</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置最大空闲连接数为默认值的3倍</span>
poolConfig<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span><span class="token class-name">GenericObjectPoolConfig</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_MAX_IDLE</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置最小空闲连接数为默认值的2倍</span>
poolConfig<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span><span class="token class-name">GenericObjectPoolConfig</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_MIN_IDLE</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置开启jmx功能</span>
poolConfig<span class="token punctuation">.</span><span class="token function">setJmxEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置连接池没有连接后客户端的最大等待时间(单位为毫秒)</span>
poolConfig<span class="token punctuation">.</span><span class="token function">setMaxWaitMillis</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>下表罗列出GenericObjectPoolConfig的一些重要属性</p> <table><thead><tr><th style="text-align:center;">参数名</th> <th style="text-align:center;">含义</th> <th style="text-align:center;">默认值</th></tr></thead> <tbody><tr><td style="text-align:center;">maxActive</td> <td style="text-align:center;">连接池中的最大连接数</td> <td style="text-align:center;">8</td></tr> <tr><td style="text-align:center;">maxIdle</td> <td style="text-align:center;">连接池中最大的空闲连接数</td> <td style="text-align:center;">8</td></tr> <tr><td style="text-align:center;">minIdle</td> <td style="text-align:center;">连接池中最小的空闲连接数</td> <td style="text-align:center;">0</td></tr> <tr><td style="text-align:center;">maxWaitMillis</td> <td style="text-align:center;">当连接池资源用尽后，调用者的最大等待时间，单位为毫秒，一般不建议用默认值</td> <td style="text-align:center;">-1，表示永远不超时，一直等</td></tr> <tr><td style="text-align:center;">testOnBorrow</td> <td style="text-align:center;">向连接池借用连接时是否做连接有效性检测，无效连接将被移除，每次连接多执行一次ping命令</td> <td style="text-align:center;">false</td></tr> <tr><td style="text-align:center;">testOnReturn</td> <td style="text-align:center;">向连接池借用归还时是否做连接有效性检测，无效连接将被移除，每次连接多执行一次<code>ping</code>命令</td> <td style="text-align:center;">false</td></tr> <tr><td style="text-align:center;">testWhileIdle</td> <td style="text-align:center;">向连接池借用连接时是否做连接空闲检测，空闲超时的连接将被移除，每次连接多执行一次<code>ping</code>命令</td> <td style="text-align:center;">false</td></tr> <tr><td style="text-align:center;">blockWhenExhausted</td> <td style="text-align:center;">当连接池资源耗尽时，是否要等待。这个参数和maxWaitMillis参数配合使用，只有当此参数为true时，maxWaitMillis才会生效</td> <td style="text-align:center;">true</td></tr></tbody></table> <h3 id="jedis使用pipeline"><a href="#jedis使用pipeline" class="header-anchor">#</a> Jedis使用Pipeline</h3> <p>在前面，我们已经介绍了Pipeline，本节我们将通过Jedis使用Redis的Pipeline特性。</p> <p>我们知道Redis提供了<code>mget</code>、<code>mset</code>方法，但是并没有提供<code>mdel</code>方法，如果想实现这个功能，可以借助Pipeline来模拟批量删除，虽然不会像<code>mget</code>和<code>mset</code>那样是一个原子命令，但是在绝大数场景下可以使用。下面，我们来实现一下<code>mdel</code>命令。</p> <p>这里我们没有写<code>try catch finally</code>，没有关闭jedis。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mdel</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1)生成pipeline对象</span>
<span class="token class-name">Pipeline</span> pipeline <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">pipelined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2)pipeline执行命令，注意此时命令并未真正执行</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
pipeline<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 3)执行命令</span>
pipeline<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，为了使用Pipeline，我们进行了以下操作：</p> <ol><li><p>利用jedis对象调用<code>jedis.pipelined()</code>方法生成一个pipeline对象。</p></li> <li><p>将del命令封装到pipeline中，可以调用<code>pipeline.del（String key）</code>，这个方法和<code>jedis.del（String key）</code>的写法是完全一致的，只不过此时不会真正的执行命令。</p></li> <li><p>使用<code>pipeline.sync()</code>方法完成此次pipeline对象的调用。</p></li></ol> <p>除了<code>pipeline.sync()</code>，还可以使用<code>pipeline.syncAndReturnAll()</code>将pipeline的命令进行返回，例如下面代码将set和incr做了一次pipeline操作，并顺序打印了两个命令的结果：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Pipeline</span> pipeline <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">pipelined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pipeline<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pipeline<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token string">&quot;counter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultList <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">syncAndReturnAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> object <span class="token operator">:</span> resultList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行程序，输出结果：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>OK
<span class="token number">1</span>
</code></pre></div><h2 id="redis客户端管理"><a href="#redis客户端管理" class="header-anchor">#</a> Redis客户端管理</h2> <p>Redis提供了客户端相关API对其状态进行监控和管理，本节将深入介绍各个API的使用方法以及在开发运维中可能遇到的问题。</p> <p><code>client list</code>命令能列出与Redis服务端相连的所有客户端连接信息。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> client list
<span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token number">331</span> <span class="token assign-left variable">addr</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:54304 <span class="token assign-left variable">fd</span><span class="token operator">=</span><span class="token number">8</span> <span class="token assign-left variable">name</span><span class="token operator">=</span> <span class="token assign-left variable">age</span><span class="token operator">=</span><span class="token number">42</span> <span class="token assign-left variable">idle</span><span class="token operator">=</span><span class="token number">34</span> <span class="token assign-left variable">flags</span><span class="token operator">=</span>N <span class="token assign-left variable">db</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">sub</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">psub</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">multi</span><span class="token operator">=</span>-1 <span class="token assign-left variable">qbuf</span><span class="token operator">=</span><span class="token number">0</span> qbuf-free<span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">obl</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">oll</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">omem</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">events</span><span class="token operator">=</span>r <span class="token assign-left variable">cmd</span><span class="token operator">=</span>client
<span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token number">332</span> <span class="token assign-left variable">addr</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:54344 <span class="token assign-left variable">fd</span><span class="token operator">=</span><span class="token number">9</span> <span class="token assign-left variable">name</span><span class="token operator">=</span> <span class="token assign-left variable">age</span><span class="token operator">=</span><span class="token number">5</span> <span class="token assign-left variable">idle</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">flags</span><span class="token operator">=</span>N <span class="token assign-left variable">db</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">sub</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">psub</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">multi</span><span class="token operator">=</span>-1 <span class="token assign-left variable">qbuf</span><span class="token operator">=</span><span class="token number">26</span> qbuf-free<span class="token operator">=</span><span class="token number">32742</span> <span class="token assign-left variable">obl</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">oll</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">omem</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">events</span><span class="token operator">=</span>r <span class="token assign-left variable">cmd</span><span class="token operator">=</span>client
</code></pre></div><p>输出结果的每一行代表一个客户端的信息，可以看到每行包含了十几个属性，它们是每个客户端的一些执行状态，理解这些属性对于Redis的开发和运维人员非常有帮助。下面将选择几个重要的属性进行说明。</p> <h3 id="客户端标识"><a href="#客户端标识" class="header-anchor">#</a> 客户端标识</h3> <p>Redis客户端标识总共有四个：id、addr、fd、name。下面解释各种标识的含义。</p> <ul><li><strong>id</strong> ：客户端连接的唯一标识，这个id是随着Redis的连接自增的，重启Redis后会重置为0。</li> <li><strong>addr</strong> ：客户端连接的ip和端口。</li> <li><strong>fd</strong>：socket的文件描述符，与<code>lsof</code>命令结果中的fd是同一个，如果fd=-1代表当前客户端不是外部客户端，而是Redis内部的伪装客户端。</li> <li><strong>name</strong>：客户端的名字，后面的<code>client setName</code>和<code>client getName</code>两个命令会对其进行说明。</li></ul> <h3 id="输入缓冲区"><a href="#输入缓冲区" class="header-anchor">#</a> 输入缓冲区</h3> <p>输入缓冲区需要查看两个指标：qbuf、qbuf-free。</p> <p>Redis为每个客户端分配了输入缓冲区，它的作用是将客户端发送的命令临时保存，同时Redis从会输入缓冲区拉取命令并执行，输入缓冲区为客户端发送命令到Redis执行命令提供了缓冲功能。</p> <p><code>client list</code>中qbuf和qbuf-free分别代表这个缓冲区的总容量和剩余容量，<strong>Redis没有提供相应的配置来规定每个缓冲区的大小，输入缓冲区会根据输入内容大小的不同动态调整，只是要求每个客户端缓冲区的大小不能超过1G，超过后客户端将被关闭。</strong></p> <h4 id="输入缓冲区使用不当产生的问题"><a href="#输入缓冲区使用不当产生的问题" class="header-anchor">#</a> 输入缓冲区使用不当产生的问题</h4> <p>输入缓冲使用不当会产生两个问题：</p> <ul><li>一旦某个客户端的输入缓冲区超过1G，客户端将会被关闭。</li> <li>输入缓冲区不受maxmemory控制，假设一个Redis实例设置了maxmemory为4G，已经存储了2G数据，但是如果此时输入缓冲区使用了3G，已经超过maxmemory限制，可能会产生数据丢失、键值淘汰、OOM等情况。</li></ul> <h4 id="输入缓冲区过大的原因"><a href="#输入缓冲区过大的原因" class="header-anchor">#</a> 输入缓冲区过大的原因</h4> <p>输入缓冲区过大主要有以下两大原因：</p> <ul><li>主要是因为Redis的处理速度跟不上输入缓冲区的输入速度，并且每次进入输入缓冲区的命令包含了大量bigkey，从而造成了输入缓冲区过大的情况。</li> <li>还有一种情况就是Redis发生了阻塞，短期内不能处理命令，造成客户端输入的命令积压在了输入缓冲区，造成了输入缓冲区过大。</li></ul> <h4 id="快速发现和监控缓冲区的方法"><a href="#快速发现和监控缓冲区的方法" class="header-anchor">#</a> 快速发现和监控缓冲区的方法</h4> <p>监控输入缓冲区异常的方法有以下两种：</p> <ul><li><p>通过定期执行<code>client list</code>命令，收集qbuf和qbuf-free找到异常的连接记录并分析，最终找到可能出问题的客户端。</p></li> <li><p>通过info命令的<code>info clients</code>模块，找到最大的输入缓冲区，例如下面命令中的<code>client_biggest_input_buf</code>代表最大的输入缓冲区，例如可以设置超过10M就进行报警。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> info clients
<span class="token comment"># Clients</span>
connected_clients:2
client_recent_max_input_buffer:2
client_recent_max_output_buffer:0
blocked_clients:0
</code></pre></div></li></ul> <p>这两种方式各有利弊：</p> <table><thead><tr><th style="text-align:center;">命令</th> <th style="text-align:center;">优点</th> <th style="text-align:center;">缺点</th></tr></thead> <tbody><tr><td style="text-align:center;">client list</td> <td style="text-align:center;">能精确分析每个客户端来定位问题</td> <td style="text-align:center;">执行速度较慢，频繁执行存在阻塞Redis的可能</td></tr> <tr><td style="text-align:center;">info clients</td> <td style="text-align:center;">执行速度块，分析过程比较简单</td> <td style="text-align:center;">不能精确定位到客户端<br>不能显示所有输入缓冲区的总量，只能显示最大的缓冲区大小</td></tr></tbody></table> <h3 id="输出缓冲区"><a href="#输出缓冲区" class="header-anchor">#</a> 输出缓冲区</h3> <p>Redis为每个客户端分配了输出缓冲区，它的作用是保存命令执行的结果返回给客户端，为Redis和客户端交互返回结果提供缓冲。</p> <p>与输入缓冲区不同的是，输出缓冲区的容量可以通过参数<code>client-outputbuffer-limit</code>来进行设置，并且输出缓冲区做得更加细致，按照客户端的不同分为三种：普通客户端、发布订阅客户端、slave客户端。我们可以根据不同的客户端类型进行相应的设置。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>client-output-buffer-limit <span class="token operator">&lt;</span>class<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>hard limit<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>soft limit<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>soft seconds<span class="token operator">&gt;</span>
</code></pre></div><p>参数说明：</p> <ul><li><p><code>&lt;class&gt;</code>：指的是客户端的类型，分为三种。</p> <ol><li><strong>normal</strong>：普通客户端</li> <li><strong>slave</strong>：slave客户端，用于复制</li> <li><strong>pubsub</strong>：发布订阅客户端</li></ol></li> <li><p><code>&lt;hard limit&gt;</code>：如果客户端使用的输出缓冲区大于，客户端会被立即关闭。</p></li> <li><p><code>&lt;soft limit&gt;</code>和<code>&lt;soft seconds&gt;</code>：如果客户端使用的输出缓冲区超过了并且持续了秒，客户端会被立即关闭。</p></li></ul> <p>Redis的默认配置是：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>client-output-buffer-limit normal <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span>
client-output-buffer-limit slave 256mb 64mb <span class="token number">60</span>
client-output-buffer-limit pubsub 32mb 8mb <span class="token number">60</span>
</code></pre></div><p>和输入缓冲区相同的是，输出缓冲区也不会受到maxmemory的限制，如果使用不当同样会造成maxmemory用满产生的数据丢失、键值淘汰、OOM等情况。</p> <p>实际上，输出缓冲区由两部分组成：固定缓冲区（16KB）和动态缓冲区，其中固定缓冲区返回比较小的执行结果，而动态缓冲区返回比较大的结果，固定缓冲区使用的是字节数组，动态缓冲区使用的是列表。当固定缓冲
区存满后会将Redis新的返回结果存放在动态缓冲区的队列中，队列中的每个对象就是每个返回结果。</p> <p><strong><code>client list</code>中的obl代表固定缓冲区的长度，oll代表动态缓冲区列表的长度，omem代表使用的字节数。</strong></p> <h4 id="监控输出缓冲区的方法"><a href="#监控输出缓冲区的方法" class="header-anchor">#</a> 监控输出缓冲区的方法</h4> <p>监控输出缓冲区的方法依然有两种：</p> <ul><li><p>通过定期执行<code>client list</code>命令，收集obl、oll、omem找到异常的连接记录并分析，最终找到可能出问题的客户端。</p></li> <li><p>通过info命令的<code>info clients</code>模块，找到输出缓冲区列表最大对象数。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> info clients
<span class="token comment"># Clients</span>
connected_clients:2
client_recent_max_input_buffer:2
client_recent_max_output_buffer:0
blocked_clients:0
</code></pre></div></li></ul> <p><strong>相比于输入缓冲区，输出缓冲区出现异常的概率相对会比较大</strong>，可以采取以下措施预防。</p> <h4 id="预防输出缓冲区异常的方法"><a href="#预防输出缓冲区异常的方法" class="header-anchor">#</a> 预防输出缓冲区异常的方法</h4> <p>预防输出缓冲区异常需要从以下几个方面着手：</p> <ul><li><p>·进行监控，设置阀值，超过阀值及时处理。</p></li> <li><p>·限制普通客户端输出缓冲区的，把错误扼杀在摇篮中。</p></li> <li><p>适当增大slave的输出缓冲区的，如果master节点写入较大，slave客户端的输出缓冲区可能会比较大，一旦slave客户端连接因为输出缓冲区溢出被kill，会造成复制重连。</p></li> <li><p>限制容易让输出缓冲区增大的命令，例如，高并发下的monitor命令就是一个危险的命令。</p></li> <li><p>及时监控内存，一旦发现内存抖动频繁，可能就是输出缓冲区过大。</p></li></ul> <h3 id="客户端的存活状态"><a href="#客户端的存活状态" class="header-anchor">#</a> 客户端的存活状态</h3> <p><code>client list</code>中的age和idle分别代表当前客户端已经连接的时间（单位：秒）和最近一次的空闲时间。当age等于idle时，说明连接一直处于空闲状态。</p> <h3 id="客户端的限制maxclients和timeout"><a href="#客户端的限制maxclients和timeout" class="header-anchor">#</a> 客户端的限制maxclients和timeout</h3> <p>Redis提供了maxclients参数来限制最大客户端连接数，一旦连接数超过maxclients，新的连接将被拒绝。maxclients默认值是10000，可以通过<code>info clients</code>来查询当前Redis的连接数。</p> <p>可以通过<code>config set maxclients</code>对最大客户端连接数进行动态设置：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> config get maxclients
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;maxclients&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;10000&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> config <span class="token builtin class-name">set</span> maxclients <span class="token number">50</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> config get maxclients 
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;maxclients&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;50&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> config <span class="token builtin class-name">set</span> maxclients <span class="token number">10000</span>
OK
</code></pre></div><p>一般来说maxclients=10000在大部分场景下已经绝对够用，但是某些情况由于业务方使用不当（例如没有主动关闭连接）可能存在大量idle连接，无论是从网络连接的成本还是超过maxclients的后果来说都不是什么好事，因此，Redis提供了timeout（单位为秒）参数来限制连接的最大空闲时间，一旦客户端连接的idle时间超过了timeout，连接将会被关闭。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#Redis默认的timeout是0，也就是不会检测客户端的空闲</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> config <span class="token builtin class-name">set</span> <span class="token function">timeout</span> <span class="token number">30</span>
OK
</code></pre></div><p>Redis的默认配置给出的timeout=0，在这种情况下客户端基本不会出现JedisConnectionException（并提示Unexpected end of stream）异常，这是基于对客户端开发的一种保护。例如很多开发人员在使用JedisPool时不会对连接池对象做空闲检测和验证，如果设置了timeout&gt;0，可能就会出现上面的异常，对应用业务造成一定影响，但是如果Redis的客户端使用不当或者客户端本身的一些问题，造成没有及时释放客户端连接，可能会造成大量的idle连接占据着很多连接资源，一旦超过maxclients；后果也是不堪设想。所在在实际开发和运维中，需要将timeout设置成大于0。</p> <h3 id="客户端类型"><a href="#客户端类型" class="header-anchor">#</a> 客户端类型</h3> <p><code>client list</code>中的flag是用于标识当前客户端的类型，例如flag=S代表当前客户端是slave客户端、flag=N代表当前是普通客户端，flag=O代表当前客户端正在执行monitor命令。</p> <p>下表列出常见的客户端类型：</p> <table><thead><tr><th style="text-align:center;">序号</th> <th style="text-align:center;">客户端类型</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">1</td> <td style="text-align:center;">N</td> <td style="text-align:center;">普通客户端</td></tr> <tr><td style="text-align:center;">2</td> <td style="text-align:center;">M</td> <td style="text-align:center;">当前客户端是master节点</td></tr> <tr><td style="text-align:center;">3</td> <td style="text-align:center;">S</td> <td style="text-align:center;">当前客户端是slave节点</td></tr> <tr><td style="text-align:center;">4</td> <td style="text-align:center;">O</td> <td style="text-align:center;">当前客户端正在执行Monitor命令</td></tr> <tr><td style="text-align:center;">5</td> <td style="text-align:center;">x</td> <td style="text-align:center;">当前客户端正在执行事务</td></tr> <tr><td style="text-align:center;">6</td> <td style="text-align:center;">b</td> <td style="text-align:center;">当前客户端正在等待阻塞事件</td></tr> <tr><td style="text-align:center;">7</td> <td style="text-align:center;">i</td> <td style="text-align:center;">当前客户端正在等待VM I/O，此状态已经废弃不用</td></tr> <tr><td style="text-align:center;">8</td> <td style="text-align:center;">d</td> <td style="text-align:center;">一个受监视的键已经被修改，exec命令将失败</td></tr> <tr><td style="text-align:center;">9</td> <td style="text-align:center;">u</td> <td style="text-align:center;">客户端未被阻塞</td></tr> <tr><td style="text-align:center;">10</td> <td style="text-align:center;">c</td> <td style="text-align:center;">回复完整输出后，关闭连接</td></tr> <tr><td style="text-align:center;">11</td> <td style="text-align:center;">A</td> <td style="text-align:center;">尽可能块地关闭连接</td></tr></tbody></table> <h3 id="设置和获取客户端名称"><a href="#设置和获取客户端名称" class="header-anchor">#</a> 设置和获取客户端名称</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>client setName xx
client getName
</code></pre></div><p><code>client setName</code>用于给客户端设置名字，这样比较容易标识出客户端的来源，我们可以先查看一下客户端信息：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> client list
<span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token number">341</span> <span class="token assign-left variable">addr</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:40098 <span class="token assign-left variable">fd</span><span class="token operator">=</span><span class="token number">8</span> <span class="token assign-left variable">name</span><span class="token operator">=</span> <span class="token assign-left variable">age</span><span class="token operator">=</span><span class="token number">19</span> <span class="token assign-left variable">idle</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">flags</span><span class="token operator">=</span>N <span class="token assign-left variable">db</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">sub</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">psub</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">multi</span><span class="token operator">=</span>-1 <span class="token assign-left variable">qbuf</span><span class="token operator">=</span><span class="token number">26</span> qbuf-free<span class="token operator">=</span><span class="token number">32742</span> <span class="token assign-left variable">obl</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">oll</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">omem</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">events</span><span class="token operator">=</span>r <span class="token assign-left variable">cmd</span><span class="token operator">=</span>client
</code></pre></div><p>例如将当前客户端命名test_client，可以执行如下操作：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> client setname test_client
OK
</code></pre></div><p>再次执行上一条命令，查看客户端信息：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> client list
<span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token number">341</span> <span class="token assign-left variable">addr</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:40098 <span class="token assign-left variable">fd</span><span class="token operator">=</span><span class="token number">8</span> <span class="token assign-left variable">name</span><span class="token operator">=</span>test_client <span class="token assign-left variable">age</span><span class="token operator">=</span><span class="token number">227</span> <span class="token assign-left variable">idle</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">flags</span><span class="token operator">=</span>N <span class="token assign-left variable">db</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">sub</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">psub</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">multi</span><span class="token operator">=</span>-1 <span class="token assign-left variable">qbuf</span><span class="token operator">=</span><span class="token number">26</span> qbuf-free<span class="token operator">=</span><span class="token number">32742</span> <span class="token assign-left variable">obl</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">oll</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">omem</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">events</span><span class="token operator">=</span>r <span class="token assign-left variable">cmd</span><span class="token operator">=</span>client
</code></pre></div><p>可以看到，此时name字段的值为test_client。</p> <p>如果想直接查看当前客户端的name，可以使用<code>client getName</code>命令，例如下面的操作：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> client getName
<span class="token string">&quot;test_client&quot;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>client getName和setName命令可以做为标识客户端来源的一种方式，但是通常来讲，在Redis只有一个应用方使用的情况下，IP和端口作为标识会更加清晰。当多个应用方共同使用一个Redis，那么此时client setName可以
作为标识客户端的一个依据。</p></div> <h3 id="杀掉指定ip地址和端口的客户端"><a href="#杀掉指定ip地址和端口的客户端" class="header-anchor">#</a> 杀掉指定IP地址和端口的客户端</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>client <span class="token function">kill</span> ip:port
</code></pre></div><p>此命令用于杀掉指定IP地址和端口的客户端，例如由于一些原因（例如设置timeout=0时产生的长时间idle的客户端），需要手动杀掉客户端连接时，可以使用<code>client kill</code>命令。</p> <h3 id="阻塞客户端连接"><a href="#阻塞客户端连接" class="header-anchor">#</a> 阻塞客户端连接</h3> <p>若我们想要阻塞客户端连接，可以使用<code>client pause</code>命令。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>client pause timeout<span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span>
</code></pre></div><p>一般情况下，<code>client pause</code>命令在以下场景起作用：</p> <ul><li><p><code>client pause</code>只对普通和发布订阅客户端有效，对于主从复制（从节点内部伪装了一个客户端）是无效的，也就是此期间主从复制是正常进行的，所以此命令可以用来让主从复制保持一致。</p></li> <li><p><code>client pause</code>可以用一种可控的方式将客户端连接从一个Redis节点切换到另一个Redis节点。</p></li></ul> <p><strong>需要注意的是在生产环境中，暂停客户端成本非常高。</strong></p> <h3 id="监控redis正在执行的命令"><a href="#监控redis正在执行的命令" class="header-anchor">#</a> 监控Redis正在执行的命令</h3> <p><code>monitor</code>命令可以用于监控Redis正在执行的命令，为了演示，我们打开两个redis-cli，一个执行<code>set</code>、<code>get</code>、 <code>ping</code>命令，另一个执行<code>monitor</code>命令。可以看到monitor命令能够监听其他客户端正在执行的命令，并记录了详细的时间戳。</p> <p>第一个Redis客户端：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> hello world
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get hello
<span class="token string">&quot;world&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">ping</span>
PONG
</code></pre></div><p>第二个Redis客户端：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> monitor
OK
<span class="token number">1570589510.267950</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">127.0</span>.0.1:40098<span class="token punctuation">]</span> <span class="token string">&quot;set&quot;</span> <span class="token string">&quot;hello&quot;</span> <span class="token string">&quot;world&quot;</span>
<span class="token number">1570589514.813916</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">127.0</span>.0.1:40098<span class="token punctuation">]</span> <span class="token string">&quot;get&quot;</span> <span class="token string">&quot;hello&quot;</span>
<span class="token number">1570589516.514599</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">127.0</span>.0.1:40098<span class="token punctuation">]</span> <span class="token string">&quot;ping&quot;</span>
</code></pre></div><p><code>monitor</code>的作用很明显，如果开发和运维人员想监听Redis正在执行的命令，就可以用<code>monitor</code>命令。但是每个客户端都有自己的输出缓冲区，既然<code>monitor</code>能监听到所有的命令，一旦Redis的并发量过大，<code>monitor</code>客户端的输出缓冲会暴涨，可能瞬间会占用大量内存。</p> <h3 id="客户端相关配置"><a href="#客户端相关配置" class="header-anchor">#</a> 客户端相关配置</h3> <p>前面已经介绍了一些客户端配置，接下来继续介绍剩余配置。</p> <ul><li><p>timeout：检测客户端空闲连接的超时时间，一旦idle时间达到了timeout，客户端将会被关闭，如果设置为0就不进行检测。</p></li> <li><p>maxclients：客户端最大连接数，但是这个参数会受到操作系统设置的限制。</p></li> <li><p>tcp-keepalive：检测TCP连接活性的周期，默认值为0，也就是不进行检测，如果需要设置，建议为60，那么Redis会每隔60秒对它创建的TCP连接进行活性检测，防止大量死连接占用系统资源。</p></li> <li><p>tcp-backlog：TCP三次握手后，会将接受的连接放入队列中，tcpbacklog就是队列的大小，它在Redis中的默认值是511。通常来讲这个参数不需要调整，但是这个参数会受到操作系统的影响，例如在Linux操作系统
中，如果/proc/sys/net/core/somaxconn小于tcp-backlog的默认值，那么在Redis启动时会看到如下日志，并建议将/proc/sys/net/core/somaxconn设置更大。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>WARNING: The TCP backlog setting of <span class="token number">511</span> cannot be enforced because /proc/
sys/net/core/somaxconn is <span class="token builtin class-name">set</span> to the lower value of <span class="token number">128</span>.
</code></pre></div><p>修改方法也非常简单，只需要执行如下命令：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> <span class="token number">511</span> <span class="token operator">&gt;</span> /proc/sys/net/core/somaxconn
</code></pre></div></li></ul> <h3 id="客户端统计片段"><a href="#客户端统计片段" class="header-anchor">#</a> 客户端统计片段</h3> <p>下面，我们先执行以下<code>info clients</code>命令。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> info clients
<span class="token comment"># Clients</span>
connected_clients:2
client_recent_max_input_buffer:2
client_recent_max_output_buffer:0
blocked_clients:0
</code></pre></div><ul><li><code>connected_clients</code>：代表当前Redis节点的客户端连接数，需要重点监控，一旦超过maxclients，新的客户端连接将被拒绝。</li> <li><code>client_longest_output_list</code>：当前所有输出缓冲区中队列对象个数的最大值。</li> <li><code>client_biggest_input_buf</code>：当前所有输入缓冲区中占用的最大容量。</li> <li><code>blocked_clients</code>：正在执行阻塞命令（例如blpop、brpop、brpoplpush）的客户端个数。</li></ul> <p>除此之外<code>info stats</code>中还包含了两个客户端相关的统计指标：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Stats</span>
total_connections_received:135
total_commands_processed:200185
instantaneous_ops_per_sec:0
total_net_input_bytes:8103762
total_net_output_bytes:1884895
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:205
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
evicted_keys:0
keyspace_hits:100011
keyspace_misses:19
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:232
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
</code></pre></div><p>在这些统计中，最重要的两个指标：</p> <ul><li><code>total_connections_received：Redis</code>自启动以来处理的客户端连接数总数。</li> <li><code>rejected_connections：Redis</code>自启动以来拒绝的客户端连接数，需要重点监控。</li></ul> <h2 id="客户端常见异常"><a href="#客户端常见异常" class="header-anchor">#</a> 客户端常见异常</h2> <p>在客户端的使用过程中，无论是客户端使用不当还是Redis服务端出现问题，客户端会反应出一些异常。本小节将分析一下Jedis使用过程中常见的异常情况。</p> <h3 id="无法从连接池获取到连接"><a href="#无法从连接池获取到连接" class="header-anchor">#</a> 无法从连接池获取到连接</h3> <p>JedisPool中的Jedis对象个数是有限的，默认是8个。这里假设使用的默认配置，如果有8个Jedis对象被占用，并且没有归还，此时调用者还要从JedisPool中借用Jedis，就需要进行等待（例如设置了maxWaitMillis&gt;0），如果在maxWaitMillis时间内仍然无法获取到Jedis对象就会抛出如下异常：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>redis.clients.jedis.exceptions.JedisConnectionException: Could not get a resource
from the pool
…
Caused by: java.util.NoSuchElementException: Timeout waiting <span class="token keyword">for</span> idle object
at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject<span class="token punctuation">(</span>GenericObjectPool.
java:449<span class="token punctuation">)</span>
</code></pre></div><p>还有一种情况，就是设置了blockWhenExhausted=false，那么调用者发现池子中没有资源时，会立即抛出异常不进行等待，下面的异常就是blockWhenExhausted=false时的效果：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>redis.clients.jedis.exceptions.JedisConnectionException: Could not get a resource
from the pool
…
Caused by: java.util.NoSuchElementException: Pool exhausted
at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject<span class="token punctuation">(</span>GenericObjectPool.
java:464<span class="token punctuation">)</span>
</code></pre></div><p>对于客户端无法从连接池获取到连接的原因，一般有以下几种可能：</p> <p>客户端方面：</p> <ol><li>高并发下连接池设置过小，出现供不应求，所以会出现上面的错误，但是正常情况下只要比默认的最大连接数（8个）多一些即可，因为正常情况下JedisPool以及Jedis的处理效率足够高。</li> <li>没有正确使用连接池，比如没有进行释放。</li> <li>存在慢查询操作，这些慢查询持有的Jedis对象归还速度会比较慢。</li></ol> <p>服务端方面：</p> <ol><li>客户端是正常的，但是Redis服务端由于一些原因造成了客户端命令执行过程的阻塞，也会使得客户端抛出这种异常。</li></ol> <h3 id="客户端读写超时"><a href="#客户端读写超时" class="header-anchor">#</a> 客户端读写超时</h3> <p>Jedis在调用Redis时，如果出现了读写超时后，会出现下面的异常：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>redis.clients.jedis.exceptions.JedisConnectionException:
java.net.SocketTimeoutException: Read timed out
</code></pre></div><p>造成该异常的原因也有以下几种：</p> <ul><li>读写超时间设置得过短。</li> <li>命令本身就比较慢。</li> <li>客户端与服务端网络不正常。</li> <li>Redis自身发生阻塞。</li></ul> <h3 id="客户端连接超时"><a href="#客户端连接超时" class="header-anchor">#</a> 客户端连接超时</h3> <p>Jedis在调用Redis时，如果出现了连接超时后，会出现下面的异常：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>redis.clients.jedis.exceptions.JedisConnectionException:
java.net.SocketTimeoutException: connect timed out
</code></pre></div><p>造成该异常的原因也有以下几种：</p> <ul><li><p>连接超时设置得过短，可以通过下面代码进行设置：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// 毫秒
jedis.getClient<span class="token punctuation">(</span><span class="token punctuation">)</span>.setConnectionTimeout<span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>Redis发生阻塞，造成tcp-backlog已满，造成新的连接失败。</p></li> <li><p>客户端与服务端网络不正常。</p></li></ul> <h3 id="客户端缓冲区异常"><a href="#客户端缓冲区异常" class="header-anchor">#</a> 客户端缓冲区异常</h3> <p>Jedis在调用Redis时，如果出现客户端数据流异常，会出现下面的异常：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>redis.clients.jedis.exceptions.JedisConnectionException: Unexpected end of stream.
</code></pre></div><p>造成这个异常的原因可能有如下几种：</p> <ul><li>输出缓冲区满。例如将普通客户端的输出缓冲区设置为1M60KB，如果使用get命令获取一个bigkey（例如3M），就会出现这个异常。</li> <li>长时间闲置连接被服务端主动断开。</li> <li>不正常并发读写：Jedis对象同时被多个线程并发操作，可能会出现上述异常。</li></ul> <h3 id="redis正在加载持久化文件"><a href="#redis正在加载持久化文件" class="header-anchor">#</a> Redis正在加载持久化文件</h3> <p>Jedis调用Redis时，如果Redis正在加载持久化文件，那么会收到下面的异常：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>redis.clients.jedis.exceptions.JedisDataException: LOADING Redis is loading the
dataset <span class="token keyword">in</span> memory
</code></pre></div><h3 id="redis使用的内存超过maxmemory配置"><a href="#redis使用的内存超过maxmemory配置" class="header-anchor">#</a> Redis使用的内存超过maxmemory配置</h3> <p>Jedis执行写操作时，如果Redis的使用内存大于maxmemory的设置，会收到下面的异常，此时应该调整maxmemory并找到造成内存增长的原因：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>redis.clients.jedis.exceptions.JedisDataException: OOM <span class="token builtin class-name">command</span> not allowed when
used memory <span class="token operator">&gt;</span> <span class="token string">'maxmemory'</span><span class="token builtin class-name">.</span>
</code></pre></div><h3 id="客户端连接数过大"><a href="#客户端连接数过大" class="header-anchor">#</a> 客户端连接数过大</h3> <p>如果客户端连接数超过了maxclients，新申请的连接就会出现如下异常：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>redis.clients.jedis.exceptions.JedisDataException: ERR max number of clients reached
</code></pre></div><p>此时新的客户端连接执行任何命令，返回结果都是如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get hello
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR max number of clients reached
</code></pre></div><p>这个问题可能会比较棘手，因为此时无法执行Redis命令进行问题修复，一般来说可以从两个方面进行着手解决：</p> <p><strong>客户端方面</strong>：如果maxclients参数不是很小的话，应用方的客户端连接数基本不会超过maxclients，通常来看是由于应用方对于Redis客户端使用不当造成的。此时如果应用方是分布式结构的话，可以通过下线部分应用节点（例
如占用连接较多的节点），使得Redis的连接数先降下来。从而让绝大部分节点可以正常运行，此时再通过查找程序bug或者调整maxclients进行问题的修复。</p> <p><strong>服务端方面</strong>：如果此时客户端无法处理，而当前Redis为高可用模式（例如Redis Sentinel和Redis Cluster），可以考虑将当前Redis做故障转移。</p> <p>此问题不存在确定的解决方式，但是无论从哪个方面进行处理，故障的快速恢复极为重要，当然更为重要的是找到问题的所在，否则一段时间后客户端连接数依然会超过maxclients。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">LastUpdated:</span> <span class="time">3/11/2021, 7:31:36 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/mr-muggle/数据库/Redis/Redis的一些有用的小功能.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        Redis的一些有用的小功能
      </a></span> <span class="next"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html">
        Redis的两种持久化机制
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> <div class="page-anchor"><div class="ant-space ant-space-vertical" style="width:100%;"><div class="ant-space-item"><div class="page-anchor-offset"><div><div class="ant-anchor-wrapper" style="max-height:100vh;"><div class="ant-anchor"><div class="ant-anchor-ink"><span class="ant-anchor-ink-ball"></span></div><div class="ant-anchor-link"><a href="#redis客户端的意义" title="Redis客户端的意义" class="ant-anchor-link-title">Redis客户端的意义</a></div><div class="ant-anchor-link"><a href="#客户端通信协议" title="客户端通信协议" class="ant-anchor-link-title">客户端通信协议</a><div class="ant-anchor-link"><a href="#客户端协议定义的发送命令格式" title="客户端协议定义的发送命令格式" class="ant-anchor-link-title">客户端协议定义的发送命令格式</a></div><div class="ant-anchor-link"><a href="#客户端协议定义的返回结果格式" title="客户端协议定义的返回结果格式" class="ant-anchor-link-title">客户端协议定义的返回结果格式</a></div></div><div class="ant-anchor-link"><a href="#java客户端-jedis" title="Java客户端-Jedis" class="ant-anchor-link-title">Java客户端-Jedis</a><div class="ant-anchor-link"><a href="#获取jedis" title="获取Jedis" class="ant-anchor-link-title">获取Jedis</a></div><div class="ant-anchor-link"><a href="#jedis的基本使用方法" title="Jedis的基本使用方法" class="ant-anchor-link-title">Jedis的基本使用方法</a></div><div class="ant-anchor-link"><a href="#jedis连接池的使用方法" title="Jedis连接池的使用方法" class="ant-anchor-link-title">Jedis连接池的使用方法</a></div><div class="ant-anchor-link"><a href="#直连和连接池方式的优缺点" title="直连和连接池方式的优缺点" class="ant-anchor-link-title">直连和连接池方式的优缺点</a></div><div class="ant-anchor-link"><a href="#连接池方式使用jedis" title="连接池方式使用Jedis" class="ant-anchor-link-title">连接池方式使用Jedis</a></div><div class="ant-anchor-link"><a href="#jedis使用pipeline" title="Jedis使用Pipeline" class="ant-anchor-link-title">Jedis使用Pipeline</a></div></div><div class="ant-anchor-link"><a href="#redis客户端管理" title="Redis客户端管理" class="ant-anchor-link-title">Redis客户端管理</a><div class="ant-anchor-link"><a href="#客户端标识" title="客户端标识" class="ant-anchor-link-title">客户端标识</a></div><div class="ant-anchor-link"><a href="#输入缓冲区" title="输入缓冲区" class="ant-anchor-link-title">输入缓冲区</a></div><div class="ant-anchor-link"><a href="#输出缓冲区" title="输出缓冲区" class="ant-anchor-link-title">输出缓冲区</a></div><div class="ant-anchor-link"><a href="#客户端的存活状态" title="客户端的存活状态" class="ant-anchor-link-title">客户端的存活状态</a></div><div class="ant-anchor-link"><a href="#客户端的限制maxclients和timeout" title="客户端的限制maxclients和timeout" class="ant-anchor-link-title">客户端的限制maxclients和timeout</a></div><div class="ant-anchor-link"><a href="#客户端类型" title="客户端类型" class="ant-anchor-link-title">客户端类型</a></div><div class="ant-anchor-link"><a href="#设置和获取客户端名称" title="设置和获取客户端名称" class="ant-anchor-link-title">设置和获取客户端名称</a></div><div class="ant-anchor-link"><a href="#杀掉指定ip地址和端口的客户端" title="杀掉指定IP地址和端口的客户端" class="ant-anchor-link-title">杀掉指定IP地址和端口的客户端</a></div><div class="ant-anchor-link"><a href="#阻塞客户端连接" title="阻塞客户端连接" class="ant-anchor-link-title">阻塞客户端连接</a></div><div class="ant-anchor-link"><a href="#监控redis正在执行的命令" title="监控Redis正在执行的命令" class="ant-anchor-link-title">监控Redis正在执行的命令</a></div><div class="ant-anchor-link"><a href="#客户端相关配置" title="客户端相关配置" class="ant-anchor-link-title">客户端相关配置</a></div><div class="ant-anchor-link"><a href="#客户端统计片段" title="客户端统计片段" class="ant-anchor-link-title">客户端统计片段</a></div></div><div class="ant-anchor-link"><a href="#客户端常见异常" title="客户端常见异常" class="ant-anchor-link-title">客户端常见异常</a><div class="ant-anchor-link"><a href="#无法从连接池获取到连接" title="无法从连接池获取到连接" class="ant-anchor-link-title">无法从连接池获取到连接</a></div><div class="ant-anchor-link"><a href="#客户端读写超时" title="客户端读写超时" class="ant-anchor-link-title">客户端读写超时</a></div><div class="ant-anchor-link"><a href="#客户端连接超时" title="客户端连接超时" class="ant-anchor-link-title">客户端连接超时</a></div><div class="ant-anchor-link"><a href="#客户端缓冲区异常" title="客户端缓冲区异常" class="ant-anchor-link-title">客户端缓冲区异常</a></div><div class="ant-anchor-link"><a href="#redis正在加载持久化文件" title="Redis正在加载持久化文件" class="ant-anchor-link-title">Redis正在加载持久化文件</a></div><div class="ant-anchor-link"><a href="#redis使用的内存超过maxmemory配置" title="Redis使用的内存超过maxmemory配置" class="ant-anchor-link-title">Redis使用的内存超过maxmemory配置</a></div><div class="ant-anchor-link"><a href="#客户端连接数过大" title="客户端连接数过大" class="ant-anchor-link-title">客户端连接数过大</a></div></div></div></div></div></div></div></div></div> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/mr-muggle/assets/js/app.03b0f33a.js" defer></script><script src="/mr-muggle/assets/js/2.c49e4524.js" defer></script><script src="/mr-muggle/assets/js/33.cbdbae4d.js" defer></script>
  </body>
</html>