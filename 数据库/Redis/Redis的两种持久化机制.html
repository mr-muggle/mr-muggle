<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Redis的两种持久化机制 | Knowledge</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" href="/mr-mugglefavicon.ico">
    <meta name="description" content="talk is cheap show me the code">
    <link rel="preload" href="/mr-muggle/assets/css/0.styles.a4a1d2b1.css" as="style"><link rel="preload" href="/mr-muggle/assets/js/app.03b0f33a.js" as="script"><link rel="preload" href="/mr-muggle/assets/js/2.c49e4524.js" as="script"><link rel="preload" href="/mr-muggle/assets/js/35.b52ec603.js" as="script"><link rel="prefetch" href="/mr-muggle/assets/js/10.b769111d.js"><link rel="prefetch" href="/mr-muggle/assets/js/11.3b528e8b.js"><link rel="prefetch" href="/mr-muggle/assets/js/12.262bc424.js"><link rel="prefetch" href="/mr-muggle/assets/js/13.701f9444.js"><link rel="prefetch" href="/mr-muggle/assets/js/14.f5836d8f.js"><link rel="prefetch" href="/mr-muggle/assets/js/15.f6ae0270.js"><link rel="prefetch" href="/mr-muggle/assets/js/16.88f016bf.js"><link rel="prefetch" href="/mr-muggle/assets/js/17.2cb6dc15.js"><link rel="prefetch" href="/mr-muggle/assets/js/18.190ccd99.js"><link rel="prefetch" href="/mr-muggle/assets/js/19.5b842041.js"><link rel="prefetch" href="/mr-muggle/assets/js/20.23e5f14f.js"><link rel="prefetch" href="/mr-muggle/assets/js/21.76eb19cf.js"><link rel="prefetch" href="/mr-muggle/assets/js/22.9a998e87.js"><link rel="prefetch" href="/mr-muggle/assets/js/23.d79bc80a.js"><link rel="prefetch" href="/mr-muggle/assets/js/24.68b1ece9.js"><link rel="prefetch" href="/mr-muggle/assets/js/25.0536eb3c.js"><link rel="prefetch" href="/mr-muggle/assets/js/26.e1e22d1b.js"><link rel="prefetch" href="/mr-muggle/assets/js/27.10fbd948.js"><link rel="prefetch" href="/mr-muggle/assets/js/28.9d8bf67a.js"><link rel="prefetch" href="/mr-muggle/assets/js/29.959e32d1.js"><link rel="prefetch" href="/mr-muggle/assets/js/3.4c2c33d8.js"><link rel="prefetch" href="/mr-muggle/assets/js/30.98fcced0.js"><link rel="prefetch" href="/mr-muggle/assets/js/31.c3717be1.js"><link rel="prefetch" href="/mr-muggle/assets/js/32.04594faa.js"><link rel="prefetch" href="/mr-muggle/assets/js/33.cbdbae4d.js"><link rel="prefetch" href="/mr-muggle/assets/js/34.112b9f11.js"><link rel="prefetch" href="/mr-muggle/assets/js/36.6a59af48.js"><link rel="prefetch" href="/mr-muggle/assets/js/37.7974b0c2.js"><link rel="prefetch" href="/mr-muggle/assets/js/38.f998387a.js"><link rel="prefetch" href="/mr-muggle/assets/js/39.89abf77c.js"><link rel="prefetch" href="/mr-muggle/assets/js/4.8c3e511b.js"><link rel="prefetch" href="/mr-muggle/assets/js/40.ec4c57c4.js"><link rel="prefetch" href="/mr-muggle/assets/js/41.ef41848b.js"><link rel="prefetch" href="/mr-muggle/assets/js/42.8538a508.js"><link rel="prefetch" href="/mr-muggle/assets/js/43.c712f5fa.js"><link rel="prefetch" href="/mr-muggle/assets/js/44.7e2435a1.js"><link rel="prefetch" href="/mr-muggle/assets/js/45.633f2d43.js"><link rel="prefetch" href="/mr-muggle/assets/js/46.1bd7c05d.js"><link rel="prefetch" href="/mr-muggle/assets/js/47.e5df90ad.js"><link rel="prefetch" href="/mr-muggle/assets/js/48.cd6c7156.js"><link rel="prefetch" href="/mr-muggle/assets/js/49.90631ebb.js"><link rel="prefetch" href="/mr-muggle/assets/js/5.6834c560.js"><link rel="prefetch" href="/mr-muggle/assets/js/50.9f214f89.js"><link rel="prefetch" href="/mr-muggle/assets/js/51.99a8dd78.js"><link rel="prefetch" href="/mr-muggle/assets/js/52.aec5051a.js"><link rel="prefetch" href="/mr-muggle/assets/js/53.7b621de8.js"><link rel="prefetch" href="/mr-muggle/assets/js/54.aa323f86.js"><link rel="prefetch" href="/mr-muggle/assets/js/55.63b233d9.js"><link rel="prefetch" href="/mr-muggle/assets/js/56.2cc8fe7b.js"><link rel="prefetch" href="/mr-muggle/assets/js/57.2a7a35c6.js"><link rel="prefetch" href="/mr-muggle/assets/js/58.3ef9ff2d.js"><link rel="prefetch" href="/mr-muggle/assets/js/59.4194402f.js"><link rel="prefetch" href="/mr-muggle/assets/js/6.ad05d8e5.js"><link rel="prefetch" href="/mr-muggle/assets/js/60.01275a59.js"><link rel="prefetch" href="/mr-muggle/assets/js/61.d314066d.js"><link rel="prefetch" href="/mr-muggle/assets/js/62.68ce6bc5.js"><link rel="prefetch" href="/mr-muggle/assets/js/63.34dea9e0.js"><link rel="prefetch" href="/mr-muggle/assets/js/64.9aaf5e00.js"><link rel="prefetch" href="/mr-muggle/assets/js/65.e4ce25ad.js"><link rel="prefetch" href="/mr-muggle/assets/js/66.5d9f1db5.js"><link rel="prefetch" href="/mr-muggle/assets/js/67.c914fc65.js"><link rel="prefetch" href="/mr-muggle/assets/js/68.5ee52c48.js"><link rel="prefetch" href="/mr-muggle/assets/js/69.680accb1.js"><link rel="prefetch" href="/mr-muggle/assets/js/7.0c092304.js"><link rel="prefetch" href="/mr-muggle/assets/js/70.cf4408b5.js"><link rel="prefetch" href="/mr-muggle/assets/js/71.33ad3ca9.js"><link rel="prefetch" href="/mr-muggle/assets/js/72.87880929.js"><link rel="prefetch" href="/mr-muggle/assets/js/73.11b998f6.js"><link rel="prefetch" href="/mr-muggle/assets/js/74.5a75b187.js"><link rel="prefetch" href="/mr-muggle/assets/js/75.5301781a.js"><link rel="prefetch" href="/mr-muggle/assets/js/76.c446bc20.js"><link rel="prefetch" href="/mr-muggle/assets/js/77.4eaa9052.js"><link rel="prefetch" href="/mr-muggle/assets/js/78.3b98b54f.js"><link rel="prefetch" href="/mr-muggle/assets/js/79.60b9a9ba.js"><link rel="prefetch" href="/mr-muggle/assets/js/8.471386f2.js"><link rel="prefetch" href="/mr-muggle/assets/js/80.7b067e03.js"><link rel="prefetch" href="/mr-muggle/assets/js/81.8274f49e.js"><link rel="prefetch" href="/mr-muggle/assets/js/82.b72070ad.js"><link rel="prefetch" href="/mr-muggle/assets/js/83.4651609d.js"><link rel="prefetch" href="/mr-muggle/assets/js/84.fffdd780.js"><link rel="prefetch" href="/mr-muggle/assets/js/85.10865df0.js"><link rel="prefetch" href="/mr-muggle/assets/js/86.5b4b0452.js"><link rel="prefetch" href="/mr-muggle/assets/js/87.a270ec2b.js"><link rel="prefetch" href="/mr-muggle/assets/js/88.8bb08b0f.js"><link rel="prefetch" href="/mr-muggle/assets/js/89.3826a944.js"><link rel="prefetch" href="/mr-muggle/assets/js/9.d8124a2e.js"><link rel="prefetch" href="/mr-muggle/assets/js/90.dbf7dede.js"><link rel="prefetch" href="/mr-muggle/assets/js/91.0823b62f.js"><link rel="prefetch" href="/mr-muggle/assets/js/92.8ec406ed.js">
    <link rel="stylesheet" href="/mr-muggle/assets/css/0.styles.a4a1d2b1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="nav-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-6 ant-col-xl-5 ant-col-xxl-4"><a href="/mr-muggle/" class="router-link-active no-logo home-link"><!----> <span class="site-name">Knowledge</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="nav-space-between ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-18 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/mr-muggle/" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          后端开发必知必会
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          前端开发必知必会
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          数据库
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          消息队列
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          搜索引擎
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          项目部署与运维
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          办公软件
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <ul class="extra-group"><!----> <!----></ul></nav></div></div> <!----></header> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/mr-muggle/数据库/Redis/初识Redis.html" title="初识 Redis" class="sidebar-link">初识 Redis</a></li><li><a href="/mr-muggle/数据库/Redis/API的理解和使用.html" title="API的理解和使用" class="sidebar-link">API的理解和使用</a></li><li><a href="/mr-muggle/数据库/Redis/Redis的一些有用的小功能.html" title="Redis的一些有用的小功能" class="sidebar-link">Redis的一些有用的小功能</a></li><li><a href="/mr-muggle/数据库/Redis/Redis客户端.html" title="Redis客户端" class="sidebar-link">Redis客户端</a></li><li><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html" title="Redis的两种持久化机制" class="active sidebar-link">Redis的两种持久化机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#rdb持久化机制" title="RDB持久化机制" class="sidebar-link">RDB持久化机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#rdb手动触发持久化机制" title="RDB手动触发持久化机制" class="sidebar-link">RDB手动触发持久化机制</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#rdb自动触发持久化机制" title="RDB自动触发持久化机制" class="sidebar-link">RDB自动触发持久化机制</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#bgsave命令触发rdb持久化流程" title="bgsave命令触发RDB持久化流程" class="sidebar-link">bgsave命令触发RDB持久化流程</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#rdb文件的处理" title="RDB文件的处理" class="sidebar-link">RDB文件的处理</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#rdb文件的优缺点" title="RDB文件的优缺点" class="sidebar-link">RDB文件的优缺点</a></li></ul></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#aof持久化机制" title="AOF持久化机制" class="sidebar-link">AOF持久化机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#aof触发持久化流程" title="AOF触发持久化流程" class="sidebar-link">AOF触发持久化流程</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#aof触发持久化流程-命令写入" title="AOF触发持久化流程-命令写入" class="sidebar-link">AOF触发持久化流程-命令写入</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#aof触发持久化流程-文件同步" title="AOF触发持久化流程-文件同步" class="sidebar-link">AOF触发持久化流程-文件同步</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#aof触发持久化流程-文件重写" title="AOF触发持久化流程-文件重写" class="sidebar-link">AOF触发持久化流程-文件重写</a></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#aof触发持久化流程-重启加载" title="AOF触发持久化流程-重启加载" class="sidebar-link">AOF触发持久化流程-重启加载</a></li></ul></li><li class="sidebar-sub-header"><a href="/mr-muggle/数据库/Redis/Redis的两种持久化机制.html#本章内容总结" title="本章内容总结" class="sidebar-link">本章内容总结</a></li></ul></li><li><a href="/mr-muggle/数据库/Redis/Redis复制配置与原理.html" title="Redis复制配置与原理" class="sidebar-link">Redis复制配置与原理</a></li><li><a href="/mr-muggle/数据库/Redis/Redis阻塞原因与处理.html" title="Redis阻塞原因与处理" class="sidebar-link">Redis阻塞原因与处理</a></li><li><a href="/mr-muggle/数据库/Redis/Redis内存管理与优化.html" title="Redis内存管理与优化" class="sidebar-link">Redis内存管理与优化</a></li></ul> </aside> <main class="page has-page-anchor"> <div class="theme-antdocs-content content__default"><h2 id="rdb持久化机制"><a href="#rdb持久化机制" class="header-anchor">#</a> RDB持久化机制</h2> <p>RDB持久化是把当前进程数据生成快照保存到硬盘的过程，触发RDB持久化过程可以分为手动触发和自动触发。</p> <p>在Redis中，总共支持RDB和AOF两种持久化机制，持久化功能有效地避免因进程退出造成的数据丢失问题，当下次重启时利用之前持久化的文件即可实现数据恢复。</p> <h3 id="rdb手动触发持久化机制"><a href="#rdb手动触发持久化机制" class="header-anchor">#</a> RDB手动触发持久化机制</h3> <p>手动触发分别对应<code>save</code>和<code>bgsave</code>命令</p> <ul><li><p><code>save</code>命令：阻塞当前Redis服务器，直到RDB过程完成为止，对于内存比较大的实例会造成长时间阻塞，线上环境不建议使用。运行<code>save</code>命令对应 的Redis日志如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>* DB saved on disk
</code></pre></div></li> <li><p><code>bgsave</code>命令：Redis进程执行fork操作创建子进程，RDB持久化过程由子进程负责，完成后自动结束。阻塞只发生在fork阶段，一般时间很短。运行<code>bgsave</code>命令对应的Redis日志如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>* Background saving started by pid <span class="token number">3151</span>
* DB saved on disk
* RDB: <span class="token number">0</span> MB of memory used by copy-on-write
* Background saving terminated with success
</code></pre></div></li></ul> <p>显然<code>bgsave</code>命令是针对<code>save</code>命令阻塞问题做的优化。<strong>因此Redis内部所有的涉及RDB的操作都采用<code>bgsave</code>的方式，而<code>save</code>命令已经废弃。</strong></p> <h3 id="rdb自动触发持久化机制"><a href="#rdb自动触发持久化机制" class="header-anchor">#</a> RDB自动触发持久化机制</h3> <p>除了执行命令手动触发之外，Redis内部还存在自动触发RDB的持久化 机制，例如以下场景：</p> <ul><li>使用save相关配置，如“save m n”。表示m秒内数据集存在n次修改时，自动触发<code>bgsave</code>。</li> <li>如果从节点执行全量复制操作，主节点自动执行<code>bgsave</code>生成RDB文件并发送给从节点。</li> <li>执行<code>debug reload</code>命令重新加载Redis时，也会自动触发save操作。</li> <li>默认情况下执行<code>shutdown</code>命令时，如果没有开启AOF持久化功能则自动执行<code>bgsave</code>。</li></ul> <h3 id="bgsave命令触发rdb持久化流程"><a href="#bgsave命令触发rdb持久化流程" class="header-anchor">#</a> <code>bgsave</code>命令触发RDB持久化流程</h3> <p><code>bgsave</code>是主流的触发RDB持久化方式，大致可以分为以下5个步骤：</p> <ol><li>执行<code>bgsave</code>命令，Redis父进程判断当前是否存在正在执行的子进程，如RDB/AOF子进程，如果存在<code>bgsave</code>命令则直接返回。</li> <li>父进程执行<code>fork</code>操作创建子进程，fork操作过程中父进程会阻塞，通 过<code>info stats</code>命令查看<code>latest_fork_usec</code>选项，可以获取最近一个fork操作的耗时，单位为微秒。</li> <li>父进程fork完成后，<code>bgsave</code>命令返回“Background saving started”信息 并不再阻塞父进程，可以继续响应其他命令。</li> <li>子进程创建RDB文件，根据父进程内存生成临时快照文件，完成后对原有文件进行原子替换。执行<code>lastsave</code>命令可以获取最后一次生成RDB的时间，对应<code>info</code>统计的<code>rdb_last_save_time</code>选项。</li> <li>进程发送信号给父进程表示完成，父进程更新统计信息。</li></ol> <h3 id="rdb文件的处理"><a href="#rdb文件的处理" class="header-anchor">#</a> RDB文件的处理</h3> <p>RDB文件的处理主要可以分为三种：保存、压缩、校验。</p> <ul><li><p><strong>保存</strong>：RDB文件保存在dir配置指定的目录下，文件名通过dbfilename配置指定。可以通过执行<code>config set dir {newDir}</code>和<code>config set dbfilename {newFileName}</code>运行期动态执行，<strong>当下次运行时RDB文件会保存到新目录。</strong></p></li> <li><p><strong>压缩</strong>：Redis默认采用LZF算法对生成的RDB文件做压缩处理，压缩后的 文件远远小于内存大小，默认开启，可以通过参数<code>config set rdbcompression {yes|no}</code>动态修改。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>虽然压缩RDB会消耗CPU，但可大幅降低文件的体积，方便保存到硬盘 或通过网络发送给从节点，因此线上建议开启。</p></div></li> <li><p><strong>校验</strong>：如果Redis加载损坏的RDB文件时拒绝启动，并打印如下日志：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Short read or OOM loading DB. Unrecoverable error, aborting now.</span>
</code></pre></div><p>这时可以使用Redis提供的redis-check-dump工具检测RDB文件并获取对应的错误报告。</p></li></ul> <h3 id="rdb文件的优缺点"><a href="#rdb文件的优缺点" class="header-anchor">#</a> RDB文件的优缺点</h3> <ul><li><p>RDB文件的优点：</p> <ol><li>RDB是一个紧凑压缩的二进制文件，代表Redis在某个时间点上的数据快照。非常适用于备份，全量复制等场景。比如每6小时执行<code>bgsave</code>备份， 并把RDB文件拷贝到远程机器或者文件系统中（如hdfs），用于灾难恢复。</li> <li>Redis加载RDB恢复数据远远快于AOF的方式。</li></ol></li> <li><p>RDB的缺点：</p> <ol><li><p>RDB方式数据没办法做到实时持久化/秒级持久化。因为<code>bgsave</code>命令每次运行都要执行fork操作创建子进程，属于重量级操作，频繁执行成本过高。</p></li> <li><p>RDB文件使用特定二进制格式保存，Redis版本演进过程中有多个格式的RDB版本，存在老版本Redis服务无法兼容新版RDB格式的问题。</p></li></ol></li></ul> <p>针对RDB不适合实时持久化的问题，Redis提供了AOF持久化方式来解决。</p> <h2 id="aof持久化机制"><a href="#aof持久化机制" class="header-anchor">#</a> AOF持久化机制</h2> <p>AOF（append only file）持久化，以独立日志的方式记录每次写命令， 重启时再重新执行AOF文件中的命令达到恢复数据的目的。AOF的主要作用是解决了数据持久化的实时性，<strong>目前已经是Redis持久化的主流方式。</strong></p> <p>开启AOF功能需要设置配置：<code>appendonly yes</code>，默认不开启。AOF文件名通过appendfilename配置设置，默认文件名是<code>appendonly.aof</code>。保存路径同RDB持久化方式一致，通过dir配置指定。</p> <h3 id="aof触发持久化流程"><a href="#aof触发持久化流程" class="header-anchor">#</a> AOF触发持久化流程</h3> <p>AOF触发持久化流程大致可以分为以下四个步骤：</p> <ol><li>命令写入（append）：所有的写入命令会追加到aof_buf（缓冲区）中。</li> <li>文件同步（sync）：AOF缓冲区根据对应的策略向硬盘做同步操作。</li> <li>文件重写（rewrite）：随着AOF文件越来越大，需要定期对AOF文件进行重写，达到压缩 的目的。</li> <li>重启加载 （load）：当Redis服务器重启时，可以加载AOF文件进行数据恢复。</li></ol> <h3 id="aof触发持久化流程-命令写入"><a href="#aof触发持久化流程-命令写入" class="header-anchor">#</a> AOF触发持久化流程-命令写入</h3> <p>AOF命令写入的内容直接是文本协议格式。例如<code>set hello world</code>这条命令，在AOF缓冲区会追加如下文本：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>*3<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$3</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nset<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$5</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nhello<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$5</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nworld<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n
</code></pre></div><p>AOF直接采用文本协议格式有以下优势：</p> <ul><li>文本协议具有很好的兼容性。</li> <li>开启AOF后，所有写入命令都包含追加操作，直接采用协议格式，避免了二次处理开销。</li> <li>文本协议具有可读性，方便直接修改和处理。</li></ul> <p>至于AOF把命令追加到aof_buf中，主要是由于以下两个原因：</p> <ul><li>Redis使用单线程响应命令，如果每次写AOF文件命令都直接追加到硬盘，那么性能完全取决于当前硬盘负 载。</li> <li>先写入缓冲区aof_buf中，还有另一个好处，Redis可以提供多种缓冲区同步硬盘的策略，在性能和安全性方面做出平衡。</li></ul> <h3 id="aof触发持久化流程-文件同步"><a href="#aof触发持久化流程-文件同步" class="header-anchor">#</a> AOF触发持久化流程-文件同步</h3> <p>Redis提供了多种AOF缓冲区同步文件策略，由参数appendfsync控制。</p> <table><thead><tr><th style="text-align:center;">可配置值</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">always</td> <td style="text-align:center;">命令写入aof_buf后调用系统fsync操作同步到AOF文件，fsync完成后线程返回</td></tr> <tr><td style="text-align:center;">everysec</td> <td style="text-align:center;">命令写入aof_buf后调用系统write操作，write完成后线程返回，fsync同步文件操作由专门线程每秒调用一次</td></tr> <tr><td style="text-align:center;">no</td> <td style="text-align:center;">命令写入aof_buf后调用系统write操作，不对AOF文件做fsync同步，同步硬盘操作由操作系统负责，通常同步周期最长30秒</td></tr></tbody></table> <p>系统调用write和fsync的区别：</p> <ul><li>write操作会触发<strong>延迟写（delayed write）机制</strong> 。Linux在内核提供页缓冲区用来提高硬盘IO性能。<strong>write操作在写入系统缓冲区后直接返回，同步硬盘操作依赖于系统调度机制</strong>，例如：缓冲区页空间写满或达到特定时间周期。同步文件之前，如果此时系统故障宕机，缓冲区内数据将丢失。</li> <li>fsync针对单个文件操作（比如AOF文件），做强制硬盘同步，<strong>fsync将阻塞直到写入硬盘完成后返回，保证了数据持久化。</strong></li></ul> <p>各种配置值的优缺点：</p> <table><thead><tr><th style="text-align:center;">可配置值</th> <th style="text-align:center;">作用</th></tr></thead> <tbody><tr><td style="text-align:center;">always</td> <td style="text-align:center;"><strong>配置为always时，每次写入都要同步AOF文件</strong>，在一般的SATA硬盘 上，Redis只能支持大约几百TPS写入，显然跟Redis高性能特性背道而驰， <strong>不建议配置</strong>。</td></tr> <tr><td style="text-align:center;">everysec</td> <td style="text-align:center;"><strong>配置为everysec，是建议的同步策略</strong>，也是默认配置，做到兼顾性能和数据安全性。理论上只有在系统突然宕机的情况下丢失1秒的数据。</td></tr> <tr><td style="text-align:center;">no</td> <td style="text-align:center;">由于操作系统每次同步AOF文件的周期不可控，而且会加大每次同步硬盘的数据量，虽然提升了性能，但数据安全性无法保证。</td></tr></tbody></table> <h3 id="aof触发持久化流程-文件重写"><a href="#aof触发持久化流程-文件重写" class="header-anchor">#</a> AOF触发持久化流程-文件重写</h3> <p>随着命令不断写入AOF，文件会越来越大，为了解决这个问题，Redis引入AOF重写机制压缩文件体积。<strong>AOF文件重写是把Redis进程内的数据转化为写命令同步到新AOF文件的过程。</strong></p> <p>重写后的AOF文件将会变小，原因如下：</p> <ul><li>进程内已经超时的数据不再写入文件。</li> <li><strong>旧的AOF文件含有无效命令</strong>，如<code>del key1</code>、<code>hdel key2</code>、<code>srem keys</code>、<code>set a111</code>、<code>set a222</code>等。<strong>重写使用进程内数据直接生成，这样新的AOF文件只保留最终数据的写入命令。</strong></li> <li><strong>多条写命令可以合并为一个</strong>，如：<code>lpush list a</code>、<code>lpush list b</code>、<code>lpush list c</code>可以转化为：<code>lpush list a b c</code>。为了防止单条命令过大造成客户端缓冲区溢出，对于list、set、hash、zset等类型操作，以64个元素为界拆分为多条。</li></ul> <p>AOF重写降低了文件占用空间，除此之外，另一个目的是：更小的AOF文件可以更快地被Redis加载。</p> <p><strong>AOF重写过程可以分为手动触发和自动触发</strong>：</p> <ul><li><p>手动触发：直接调用<code>bgrewriteaof</code>命令。</p></li> <li><p>自动触发：根据<code>auto-aof-rewrite-min-size</code>和<code>auto-aof-rewrite-percentage</code>参数确定自动触发时机。<code>auto-aof-rewrite-min-size</code>表示运行AOF重写时文件最小体积，默认为64MB。<code>auto-aof-rewrite-percentage</code>代表当前AOF文件空间 （<code>aof_current_size</code>）和上一次重写后AOF文件空间（<code>aof_base_size</code>）的比值。</p> <p>自动触发AOF重写时机满足以下条件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>aof_current_size<span class="token operator">&gt;</span>auto-aof-rewrite-minsize <span class="token operator">&amp;&amp;</span>（aof_current_size-aof_base_size）/aof_base_size<span class="token operator">&gt;=</span>auto-aof-rewritepercentage
</code></pre></div><p>其中<code>aof_current_size</code>和<code>aof_base_size</code>可以在info Persistence统计信息中查看。</p></li></ul> <h3 id="aof触发持久化流程-重启加载"><a href="#aof触发持久化流程-重启加载" class="header-anchor">#</a> AOF触发持久化流程-重启加载</h3> <p>AOF和RDB文件都可以用于服务器重启时的数据恢复。</p> <ol><li><p>AOF持久化开启且存在AOF文件时，优先加载AOF文件。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>* DB loaded from append only file: <span class="token number">5.841</span> seconds
</code></pre></div></li> <li><p>AOF关闭或者AOF文件不存在时，加载RDB文件。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>* DB loaded from disk: <span class="token number">5.586</span> seconds
</code></pre></div></li> <li><p>加载AOF/RDB文件成功后，Redis启动成功。</p></li> <li><p>AOF/RDB文件存在错误时，Redis启动失败并打印错误信息。</p> <p>加载损坏的AOF文件时会拒绝启动，并打印如下日志：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Bad file format reading the append only file: make a backup of your AOF file,</span>
<span class="token keyword">then</span> use ./redis-check-aof <span class="token parameter variable">--fix</span> <span class="token operator">&lt;</span>filename<span class="token operator">&gt;</span>
</code></pre></div><p>对于错误格式的AOF文件，先进行备份，然后采用<code>redis-check-aof --fix</code>命令进行修复，修复后使用<code>diff-u</code>对比数据的差异，找出丢失的数据，有些可以人工修改补全。</p> <p>AOF文件可能存在结尾不完整的情况，比如机器突然掉电导致AOF尾部文件命令写入不全。Redis为我们提供了<code>aof-load-truncated</code>配置来兼容这种情况，默认开启。加载AOF时，当遇到此问题时会忽略并继续启动，同时打印如下警告日志：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># !!! Warning: short read while loading the AOF file !!!</span>
<span class="token comment"># !!! Truncating the AOF at offset 397856725 !!!</span>
<span class="token comment"># AOF loaded anyway because aof-load-truncated is enabled</span>
</code></pre></div></li></ol> <h2 id="本章内容总结"><a href="#本章内容总结" class="header-anchor">#</a> 本章内容总结</h2> <ol><li><p>Redis提供了两种持久化方式：RDB和AOF。</p></li> <li><p>RDB使用一次性生成内存快照的方式，产生的文件紧凑压缩比更高，因此读取RDB恢复速度更快。由于每次生成RDB开销较大，无法做到实时持久化，一般用于数据冷备和复制传输。</p></li> <li><p><code>save</code>命令会阻塞主线程不建议使用，<code>bgsave</code>命令通过fork操作创建子进程生成RDB避免阻塞。</p></li> <li><p>AOF通过追加写命令到文件实现持久化，通过appendfsync参数可以控制实时/秒级持久化。因为需要不断追加写命令，所以AOF文件体积逐渐变大，需要定期执行重写操作来降低文件体积。</p></li> <li><p>AOF重写可以通过<code>auto-aof-rewrite-min-size</code>和<code>auto-aof-rewrite-percentage</code>参数控制自动触发，也可以使用<code>bgrewriteaof</code>命令手动触发。子进程执行期间使用copy-on-write机制与父进程共享内存，避免内 存消耗翻倍。AOF重写期间还需要维护重写缓冲区，保存新的写入命令避免数据丢失。</p></li> <li><p>持久化阻塞主线程场景有：fork阻塞和AOF追加阻塞。fork阻塞时间跟内存量和系统有关，AOF追加阻塞说明硬盘资源紧张。</p></li> <li><p>单机下部署多个实例时，为了防止出现多个子进程执行重写操作，建议做隔离控制，避免CPU和IO资源竞争。</p></li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">LastUpdated:</span> <span class="time">3/11/2021, 7:31:36 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/mr-muggle/数据库/Redis/Redis客户端.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        Redis客户端
      </a></span> <span class="next"><a href="/mr-muggle/数据库/Redis/Redis复制配置与原理.html">
        Redis复制配置与原理
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> <div class="page-anchor"><div class="ant-space ant-space-vertical" style="width:100%;"><div class="ant-space-item"><div class="page-anchor-offset"><div><div class="ant-anchor-wrapper" style="max-height:100vh;"><div class="ant-anchor"><div class="ant-anchor-ink"><span class="ant-anchor-ink-ball"></span></div><div class="ant-anchor-link"><a href="#rdb持久化机制" title="RDB持久化机制" class="ant-anchor-link-title">RDB持久化机制</a><div class="ant-anchor-link"><a href="#rdb手动触发持久化机制" title="RDB手动触发持久化机制" class="ant-anchor-link-title">RDB手动触发持久化机制</a></div><div class="ant-anchor-link"><a href="#rdb自动触发持久化机制" title="RDB自动触发持久化机制" class="ant-anchor-link-title">RDB自动触发持久化机制</a></div><div class="ant-anchor-link"><a href="#bgsave命令触发rdb持久化流程" title="bgsave命令触发RDB持久化流程" class="ant-anchor-link-title">bgsave命令触发RDB持久化流程</a></div><div class="ant-anchor-link"><a href="#rdb文件的处理" title="RDB文件的处理" class="ant-anchor-link-title">RDB文件的处理</a></div><div class="ant-anchor-link"><a href="#rdb文件的优缺点" title="RDB文件的优缺点" class="ant-anchor-link-title">RDB文件的优缺点</a></div></div><div class="ant-anchor-link"><a href="#aof持久化机制" title="AOF持久化机制" class="ant-anchor-link-title">AOF持久化机制</a><div class="ant-anchor-link"><a href="#aof触发持久化流程" title="AOF触发持久化流程" class="ant-anchor-link-title">AOF触发持久化流程</a></div><div class="ant-anchor-link"><a href="#aof触发持久化流程-命令写入" title="AOF触发持久化流程-命令写入" class="ant-anchor-link-title">AOF触发持久化流程-命令写入</a></div><div class="ant-anchor-link"><a href="#aof触发持久化流程-文件同步" title="AOF触发持久化流程-文件同步" class="ant-anchor-link-title">AOF触发持久化流程-文件同步</a></div><div class="ant-anchor-link"><a href="#aof触发持久化流程-文件重写" title="AOF触发持久化流程-文件重写" class="ant-anchor-link-title">AOF触发持久化流程-文件重写</a></div><div class="ant-anchor-link"><a href="#aof触发持久化流程-重启加载" title="AOF触发持久化流程-重启加载" class="ant-anchor-link-title">AOF触发持久化流程-重启加载</a></div></div><div class="ant-anchor-link"><a href="#本章内容总结" title="本章内容总结" class="ant-anchor-link-title">本章内容总结</a></div></div></div></div></div></div></div></div> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/mr-muggle/assets/js/app.03b0f33a.js" defer></script><script src="/mr-muggle/assets/js/2.c49e4524.js" defer></script><script src="/mr-muggle/assets/js/35.b52ec603.js" defer></script>
  </body>
</html>